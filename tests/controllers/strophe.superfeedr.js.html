<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="http://code.jquery.com/qunit/git/qunit.js"></script>

    <!-- Dependencies -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 

    <!-- strope.superfeedr.js -->
    <script type="text/javascript" src="../../controllers/strophe.superfeedr.js"></script>

    <script>

	var websocketEndpoint = 'ws://zipline.local:5288/ws-xmpp'
	var connection = null
	
    function log(msg) {
        $('#log').append('<div></div><br />').append(document.createTextNode(msg));
    }

    function rawInput(data) {
        log('RECV: ' + data);
    }

    function rawOutput(data) {
        log('SENT: ' + data);
    }


    $(document).ready(function(){

        connection = new Strophe.Connection({
		    protocol: new Strophe.Websocket(websocketEndpoint)
		});
		
        connection.rawInput = rawInput;
        connection.rawOutput = rawOutput;

        connection.connect("subscriber@superfeedr.com", "subscriber", onConnect);

        function onConnect(status) {
            if (status == Strophe.Status.CONNECTING) {
                log('Strophe is connecting.');
            } else if (status == Strophe.Status.CONNFAIL) {
                log('Strophe failed to connect.');
            } else if (status == Strophe.Status.DISCONNECTING) {
                log('Strophe is disconnecting.');
            } else if (status == Strophe.Status.DISCONNECTED) {
                log('Strophe is disconnected.');
            } else if (status == Strophe.Status.CONNECTED) {
                log('Strophe is connected.');
                
                // Adds the handler for notificatations
                connection.superfeedr.addNotificationHandler(function(message) {
                    test("Test Notification", function() {
                        notEqual(message['id'], null, "The id should not be null");
                        notEqual(message['title'], null, "The title should not be null");
                        notEqual(message['links'], null, "The links should not be null");
                    });
                    connection.superfeedr.unsubscribe("http://superfeedr.com/track/music", function(result) {
                    })
                })
                // Tests subscription
                connection.superfeedr.subscribe("http://blog.superfeedr.com/atom.xml", function(result) {
                    test("Test subscription", function() {
                        if(result) {
                            ok( true, "Subscribed successfully");
                            // Tests unsubscription
                            connection.superfeedr.unsubscribe("http://blog.superfeedr.com/atom.xml", function(result) {
                                test("Test unsubscription", function() {
                                    if(result) {
                                        ok( true, "Unsubscribed successfully");
                                        // Tests List
                                        connection.superfeedr.subscribe("http://blog.superfeedr.com/atom.xml", function(result) {
                                            connection.superfeedr.subscribe("https://github.com/superfeedr.atom", function(result) {
                                                connection.superfeedr.list(1, function(result) {
                                                    test("Test Subscription listing", function() {
                                                        ok(_.include(result, "https://github.com/superfeedr.atom"), "Includes subscription to https://github.com/superfeedr.atom");
                                                        ok(_.include(result, "http://blog.superfeedr.com/atom.xml"), "Includes subscription to http://blog.superfeedr.com/atom.xml");
                                                        connection.superfeedr.subscribe("http://superfeedr.com/track/music", function(result) {
                                                            // Nothing to do here.
                                                        });
                                                        
                                                    })
                                                })
                                            })
                                        })
                                    }
                                    else {
                                        ok( false, "Failed unsubscription");
                                    }
                                })
                            })
                        }
                        else {
                            ok( false, "Failed subscription");
                        }
                    });
                })

            }
        }
    });
    </script>

</head>
<body>
    <h1 id="qunit-header">Xmpp Connection QUnit test</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="log" style=""></div>
</body>
</html>