<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <link rel="stylesheet" href="../qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="../qunit.js"></script>

    <!-- Dependencies -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script>
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script>
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script>


    <script src="../../controllers/msgboy.js" type="text/javascript"></script> 
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
    <script src="../../controllers/error_notifier.js" type="text/javascript"></script> 
    
    <!-- Model includes -->
    <script src="../../models/database.js" type="text/javascript"></script>
    <script src="../../models/message.js" type="text/javascript"></script>
    <script src="../../models/archive.js" type="text/javascript"></script>
    <script src="../../models/inbox.js" type="text/javascript"></script>
    
    <title>Error Notifier QUnit test</title>
</head>
<body>
    <h1 id="qunit-header">Archive QUnit test</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="log" style=""></div>
    
    <script>

        var getStackTrace = function() {
          var obj = {};
          Error.captureStackTrace(obj, getStackTrace);
          var lines = obj.stack.split("\n");
          var stack = [];
          lines.forEach(function(line) {
              stack.push(line.trim().replace("at", "").trim());
          })
          return stack;
        };
        
        function dieInHell() {
            dieInHell2();
        }
        function dieInHell2() {
            dieInHell3();
        }
        function dieInHell3() {
            try {
                dieInHell5()
            }
            catch(e) {
                e.stack = getStackTrace();
                console.log(AirbrakeNotifier.generateXML(e));
            }
            dieInHell4();
            
        }

        window.onerror = function (message, file, line) {
            setTimeout(function () {
                var error = {
                    message  : message,
                    arguments: [],
                    stack    : [], // We need a better way to extract the stack. The problem with this method is that the context changes with onerror and there is no way to retrieve te actual error/exception object.
                    type     : ""
                }
                
                console.log(AirbrakeNotifier.generateXML(error));
                
            }, 100);
            return true;
        };
        
        Msgboy.bind("loaded", function () {
            Msgboy.inbox = new Inbox();
            Msgboy.inbox.bind("change", function () {
                dieInHell();
            });
            Msgboy.inbox.fetch();
        });
        Msgboy.run();
    </script>
    
</body>
</html>