<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <link rel="stylesheet" href="../qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="../qunit.js"></script>

    <!-- Dependencies -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../lib/date.extensions.js" type="text/javascript"></script>
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script>
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script>
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script>
    <script src="../../lib/readability/readability.js" type="text/javascript"></script>
    <script src="../../controllers/utils.js" type="text/javascript"></script>
    
    <script src="../../models/database.js" type="text/javascript"></script>
    <script src="../../models/message.js" type="text/javascript"></script>
    <script src="../../models/archive.js" type="text/javascript"></script>
    <script src="../../models/inbox.js" type="text/javascript"></script>
    
    <title>Archive QUnit test</title>
</head>
<body>
    <h1 id="qunit-header">Archive QUnit test</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="log" style=""></div>
    
    <script>
        var messages = [
            {
                created_at: new Date().getTime(),
                unread_at: new Date().getTime(),
                read_at: 0,
                starred_at: 0,
                alternate: "http://blog.superfeedr.com",
                host: "blog.superfeedr.com",
                alternate_new: "http://blog.superfeedr.com"
            },
            {
                created_at: new Date().getTime(),
                unread_at: new Date().getTime(),
                read_at: 0,
                starred_at: 0,
                alternate: "http://blog.superfeedr.com",
                host: "blog.superfeedr.com",
                alternate_new: "http://blog.superfeedr.com"
            },
            {
                created_at: new Date().getTime(),
                unread_at: new Date().getTime(),
                read_at: 0,
                starred_at: 0,
                alternate: "http://blog.superfeedr.com",
                host: "blog.superfeedr.com",
                alternate_new: "http://blog.superfeedr.com"
            }
        ]
        
        function addFixtures(messages, done) {
            var message = messages.shift();
            if(message) {
                var msg = new Message();
                msg.save(message, {
                    success: function(obj, err) {
                        addFixtures(messages, done);
                    },
                    error: function(obj, err) {
                        addFixtures(messages, done);
                    }
                });
            }
            else {
                done();
            }
        }
    
        // module("mark_all_as_read");
        // 
        // asyncTest("it should mark all as read", function() {
        // });
        
        module("delete_all");

        asyncTest("it should delete all the messages that match the criteria submitted", function() {
            addFixtures(messages, function() {
                // Let's now fetch all elements matching the alternate index
                var archive = new Archive();
                archive.fetch_all( {alternate: "http://blog.superfeedr.com"}, function() {
                    start();
                    ok(archive.length == 3, "There should be 3 items in the array matching this criteria");
                    archive.delete_all({alternate: "http://blog.superfeedr.com"}, function() {
                        archive.fetch_all( {alternate: "http://blog.superfeedr.com"}, function() {
                            start();
                            ok(archive.length == 0, "There should be no more items in the array matching this criteria");
                            // We should make sure other items are still there as well....
                        });
                    });
                });
            });
        });

        asyncTest("it should delete all the messages if there is no criteria", function() {
            addFixtures(messages, function() {
                // Let's now fetch all elements matching the alternate index
                var archive = new Archive();
                archive.fetch_all(function() {
                    start();
                    ok(archive.length == 5, "There should be 5 items in the array of messages");
                    archive.delete_all(function() {
                        archive.fetch_all(function() {
                            start();
                            ok(archive.length == 0, "There should be no more items in the array matching this criteria");
                            // We should make sure other items are still there as well....
                        });
                    });
                });
            });
            
        });
        
        // 
        // module("fetch_more");
        // 
        // asyncTest("it should get more of the messages matching that criteria", function() {
        // });

    </script>
    
</body>
</html>