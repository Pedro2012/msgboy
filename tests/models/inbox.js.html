<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <link rel="stylesheet" href="../qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="../qunit.js"></script>

    <!-- Dependencies -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../lib/date.extensions.js" type="text/javascript"></script>
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script>
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script>
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script>
    <script src="../../lib/readability/readability.js" type="text/javascript"></script>
    <script src="../../controllers/utils.js" type="text/javascript"></script>
    
    <script src="../../models/database.js" type="text/javascript"></script>
    <script src="../../models/message.js" type="text/javascript"></script>
    <script src="../../models/archive.js" type="text/javascript"></script>
    <script src="../../models/inbox.js" type="text/javascript"></script>
    
    <title>Inbox QUnit test</title>
</head>
<body>
    <h1 id="qunit-header">Inbox QUnit test</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="log" style=""></div>
    
    <script>
    
        module("addMessage");
        
        asyncTest("it should set the created_at attribute", function() {
            var inbox = new Inbox({id: 1});
            
            var msg = {
            };
            inbox.addMessage(msg, {
                success: function(message) {
                    start();
                    ok(message.attributes.created_at > new Date().getTime()-1000, "");
                    message.destroy();
                }
            });
        });
        
        asyncTest("it should set the unread_at attribute", function() {
            var inbox = new Inbox({id: 1});
            var msg = {
            };
            inbox.addMessage(msg, {
                success: function(message) {
                    start();
                    ok(message.attributes.unread_at > new Date().getTime()-1000, "");
                    message.destroy();
                }
            });
        });
        
        asyncTest("it should set the alternate attribute to  msg.source.links.alternate['text/html'][0].href", function() {
            var inbox = new Inbox({id: 1});
            var url = "http://blog.superfeedr.com/atom.xml";
            var msg = {
            };
            msg.source = {};
            msg.source.links = {};
            msg.source.links.alternate = {};
            msg.source.links.alternate['text/html'] = [];
            msg.source.links.alternate['text/html'][0] = {
                href: url,
                title: "title",
                rel:'alternate'
            };
            
            inbox.addMessage(msg, {
                success: function(message) {
                    start();
                    equal(message.attributes.alternate, url, "");
                    message.destroy();
                }
            });
        });
        
        asyncTest("it should not fail to set the alternate attribute if  msg.source.links.alternate['text/html'][0] is missing", function() {
            var inbox = new Inbox({id: 1});
            var msg = {
            };
            msg.source = {};
            msg.source.links = {};
            msg.source.links.alternate = {};
            msg.source.links.alternate['text/html'] = [];
            
            inbox.addMessage(msg, {
                success: function(message) {
                    start();
                    equal(message.attributes.alternate, "", "");
                    message.destroy();
                }
            });
        });
        
        asyncTest("it should not fail to set the alternate attribute if  msg.source.links.alternate['text/html'] is missing", function() {
            var inbox = new Inbox({id: 1});
            var msg = {
            };
            msg.source = {};
            msg.source.links = {};
            msg.source.links.alternate = {};
            
            inbox.addMessage(msg, {
                success: function(message) {
                    start();
                    equal(message.attributes.alternate, "", "");
                    message.destroy();
                }
            });
            
        });
        
        asyncTest("it should not fail to set the alternate attribute if  msg.source.links.alternate is missing", function() {
            var inbox = new Inbox({id: 1});
            var msg = {
            };
            msg.source = {};
            msg.source.links = {};
        
            inbox.addMessage(msg, {
                success: function(message) {
                    start();
                    equal(message.attributes.alternate, "", "");
                    message.destroy();
                }
            });    
        });
        
        asyncTest("it should not fail to set the alternate attribute if  msg.source.links is missing", function() {
            var inbox = new Inbox({id: 1});
            var msg = {
            };
            msg.source = {};
        
            inbox.addMessage(msg, {
                success: function(message) {
                    start();
                    equal(message.attributes.alternate, "", "");
                    message.destroy();
                }
            });    
        });
        
        asyncTest("it should not fail to set the alternate attribute if  msg.source is missing", function() {
            var inbox = new Inbox({id: 1});
            var msg = {
            };
        
            inbox.addMessage(msg, {
                success: function(message) {
                    start();
                    equal(message.attributes.alternate, "", "");
                    message.destroy();
                }
            });
        });
        
        asyncTest("it should not create a message if one already exists with that id", function() {
            var inbox = new Inbox({id: 1});
            var msg = {
                id: "123"
            };
            message = new Message(msg);
            message.destroy({
                success: function(object) {
                    inbox.addMessage(msg, {
                        success: function(message) {
                            var msg2 = {
                                id: "123"
                            };
                            inbox.addMessage(msg2, {
                                success: function(message2) {
                                    start();
                                    equal(message2, null, "it should yield null");
                                    message.destroy();
                                }, 
                                error: function() {
                                    start();
                                    ok(false, "it should be able to save the 2nd message");
                                }
                            });
                        },
                        error: function() {
                            // Dang!
                            start();
                            ok(false, "it should be able to save the first message");
                        }
                    });
                },
                error: function(object) {
                    inbox.addMessage(msg, {
                        success: function(message) {
                            var msg2 = {
                                id: "123"
                            };
                            inbox.addMessage(msg2, {
                                success: function(message2) {
                                    start();
                                    equal(message2, null, "it should yield null");
                                    message.destroy();
                                }, 
                                error: function() {
                                    start();
                                    ok(false, "it should be able to save the 2nd message");
                                }
                            });
                        },
                        error: function() {
                            // Dang!
                            start();
                            ok(false, "it should be able to save the first message");
                        }
                    });
                }
            })
        });

        asyncTest("it should save a message with all the right attributes if none exists with that id", function() {
            var inbox = new Inbox({id: 1});
            var msg = {
                id: "123",
                title: "hello world",
                content: "bonjour PAris, je suis content d'etre ici",
                author: "Julien"
            };
            message = new Message(msg);
            message.destroy({
                success: function(object) {
                    inbox.addMessage(msg, {
                        success: function(message) {
                            start();
                            for(var attr in msg) {
                                equal(msg[attr], message.attributes[attr]);
                            }
                        },
                        error: function() {
                            // Dang!
                            start();
                            ok(false, "it should be able to save the message");
                        }
                    });
                },
                error: function(object) {
                    inbox.addMessage(msg, {
                        success: function(message) {
                            start();
                            for(var attr in msg) {
                                equal(msg[attr], message.attributes[attr]);
                            }
                        },
                        error: function() {
                            // Dang!
                            start();
                            ok(false, "it should be able to save the first message");
                        }
                    });
                }
            });
        });
        
        asyncTest("it should trigger messages:added", function() {
            var inbox = new Inbox({id: 1});
            var msg = {
                title: "hello"
            };
            
            inbox.bind("messages:added", function(message) {
                start();
                equal(message.attributes.title, msg.title, "");
            });
            
            inbox.addMessage(msg, {
                success: function(message) {
                    message.destroy();
                }
            });
        });
        
    </script>
    
</body>
</html>