<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="http://code.jquery.com/qunit/git/qunit.js"></script>

    <!-- Dependencies -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../lib/date.extensions.js" type="text/javascript"></script>
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script>
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script>
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script>
    <script src="../../controllers/utils.js" type="text/javascript"></script>
    
    <script src="../../models/database.js" type="text/javascript"></script>
    <script src="../../models/message.js" type="text/javascript"></script>
    <script src="../../models/feed.js" type="text/javascript"></script>
    <script src="../../models/archive.js" type="text/javascript"></script>
    <script src="../../models/inbox.js" type="text/javascript"></script>

    <!-- Fixtures -->
    <script src="../fixtures/feeds.js" type="text/javascript"></script>

</head>
<body>
    <h1 id="qunit-header">Feed QUnit test</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="log" style=""></div>
    
    
    <script>
        module("mark_as_seen");
        asyncTest("it should mark a new feed as seen very recently", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                var seen = feed.attributes.seen_at
                feed.mark_as_seen({
                    success: function() {
                        start();
                        deepEqual(seen, []);
                        equals(feed.attributes.seen_at.length, 1);
                        ok(feed.attributes.seen_at[0] <= new Date().getTime());
                        ok(feed.attributes.seen_at[0] > new Date().getTime() - 1000 * 3);
                    }
                })
            });
        });
        asyncTest("it should keep only 10 elements", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                var seen = feed.attributes.seen_at
                var count = 0;
                feed.mark_as_seen({
                    success: function() {
                        count++;
                        feed.mark_as_seen({
                            success: function() {
                                count++;
                                feed.mark_as_seen({
                                    success: function() {
                                        count++;
                                        feed.mark_as_seen({
                                            success: function() {
                                                count++;
                                                feed.mark_as_seen({
                                                    success: function() {
                                                        count++;
                                                        feed.mark_as_seen({
                                                            success: function() {
                                                                count++;
                                                                feed.mark_as_seen({
                                                                    success: function() {
                                                                        count++;
                                                                        feed.mark_as_seen({
                                                                            success: function() {
                                                                                count++;
                                                                                feed.mark_as_seen({
                                                                                    success: function() {
                                                                                        count++;
                                                                                        feed.mark_as_seen({
                                                                                            success: function() {
                                                                                                count++;
                                                                                                feed.mark_as_seen({
                                                                                                    success: function() {
                                                                                                        count++;
                                                                                                        start();
                                                                                                    
                                                                                                        equals(count, 11);
                                                                                                    equals(feed.attributes.seen_at.length, 10);
                                                                                                    }
                                                                                                });
                                                                                            }
                                                                                        });
                                                                                    }
                                                                                });
                                                                            }
                                                                        });
                                                                    }
                                                                });
                                                            }
                                                        });
                                                    }
                                                });
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
            });
        });
        
        module("mark_as_skipped");
        asyncTest("it should mark the feed as skipped recently", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                var last_skipped_at = feed.attributes.last_skipped_at
                feed.mark_as_skipped({
                    success: function() {
                        start();
                        deepEqual(last_skipped_at, null);
                        ok(feed.attributes.last_skipped_at <= new Date().getTime());
                        ok(feed.attributes.last_skipped_at > new Date().getTime() - 1000 * 3);
                    }
                })
                
            });
        });
        asyncTest("it should reset the seen counter", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                var last_skipped_at = feed.attributes.last_skipped_at
                var seen = null
                feed.mark_as_seen({
                    success: function() {
                        seen = feed.attributes.seen_at
                        feed.mark_as_skipped({
                            success: function() {
                                start();
                                equals(feed.attributes.seen_at.length, 0);
                                equals(seen.length, 1);
                            }
                        });
                    }
                });
            });
        });
        
        module("mark_as_subscribed");
        asyncTest("it should mark the feed as subscribed recently", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                var last_subscribed_at = feed.attributes.last_subscribed_at
                feed.mark_as_subscribed({
                    success: function() {
                        start();
                        deepEqual(last_subscribed_at, null);
                        ok(feed.attributes.last_subscribed_at <= new Date().getTime());
                        ok(feed.attributes.last_subscribed_at > new Date().getTime() - 1000 * 3);
                    }
                })
                
            });
        });
        asyncTest("it should reset the seen counter", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                var last_subscribed_at = feed.attributes.last_subscribed_at
                var seen = null
                feed.mark_as_seen({
                    success: function() {
                        seen = feed.attributes.seen_at
                        feed.mark_as_subscribed({
                            success: function() {
                                start();
                                equals(feed.attributes.seen_at.length, 0);
                                equals(seen.length, 1);
                            }
                        });
                    }
                });
            });
        });
        
        
        module("needs_suggestion");
        asyncTest("it should return false when the feed was subscribed less than 1 month ago", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                feed.mark_as_subscribed({
                    success: function() {
                        start();
                        ok(!feed.needs_suggestion())
                    }
                });
            })
        });
        
        asyncTest("it should return false when the feed was skipped less than 1 month ago", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                feed.mark_as_skipped({
                    success: function() {
                        start();
                        ok(!feed.needs_suggestion())
                    }
                });
            })
        });
        
        asyncTest("it should return false if the feed as been seen less than 3 times", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                feed.attributes.seen_at = [1,2]
                start();
                ok(!feed.needs_suggestion())
            });
        });
        
        asyncTest("it should return false if the feed as been seen 3 regular times but in less than 2 hours", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                var now = new Date().getTime();
                feed.attributes.seen_at = [now - 1000 * 60 * 60, now - 1000 * 60 * 60 * 0.75, now - 1000 * 60 * 60 * 0.5, now - 1000 * 60 * 60 * 0.25];
                start();
                ok(!feed.needs_suggestion())
            });
        });

        asyncTest("it should return true if the feed as been seen 4 regular times", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                var now = new Date().getTime();
                feed.attributes.seen_at = [now - 1000 * 60 * 60 * 4, now - 1000 * 60 * 60 * 3, now - 1000 * 60 * 60 * 2, now - 1000 * 60 * 60 * 1];
                start();
                ok(feed.needs_suggestion())
            });
        });

        asyncTest("it should return true if the feed as been seen 10 regular times", function() {
            feedFixtures.clean_add(function() {
                var feed = new Feed({id: 1});
                var now = new Date().getTime();
                var hour = 1000 * 60 * 60
                feed.attributes.seen_at = [now - hour * 10, now - hour * 9, now - hour * 8, now - hour * 7, now - hour * 6, now - hour * 5, now - hour * 4, now - hour * 3, now - hour * 2, now - hour * 1];
                start();
                ok(feed.needs_suggestion())
            });
        });
        
         asyncTest("it should return false if the feed as been seen 10 unregular times", function() {
                feedFixtures.clean_add(function() {
                    var feed = new Feed({id: 1});
                    var now = new Date().getTime();
                    var hour = 1000 * 60 * 60
                    feed.attributes.seen_at = [now - hour * 100, now - hour * 80, now - hour * 78, now - hour * 30, now - hour * 28, now - hour * 14, now - hour * 12, now - hour * 2, now - hour * 1.5, now - hour * 1];
                    start();
                    ok(!feed.needs_suggestion())
                });
            });

        
    </script>
    
</body>
</html>