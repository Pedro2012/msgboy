<!DOCTYPE HTML>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <title>
            Training
        </title>
        <meta name="application-name" content="Msgboy" />
        <link rel="stylesheet" href="../css/training.css" />
        <link rel="stylesheet" href="../css/readability.css" />
        <link rel="stylesheet" href="../css/readability-print.css" />
        <link rel="stylesheet" href="../css/modalbox.css" />
        
        <!-- Lib includes -->
        <script src="../../lib/jquery/jquery.js" type="text/javascript"></script>
        <script src="../../lib/date.extensions.js" type="text/javascript"></script>
        <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script>
        <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script>
        <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script>
        <script src="../../lib/readability/readability.js" type="text/javascript"></script>
        
        <!-- Model includes -->
        <script src="../../models/database.js" type="text/javascript"></script>
        <script src="../../models/message.js" type="text/javascript"></script>
        <script src="../../models/archive.js" type="text/javascript"></script>
        <script src="../../models/inbox.js" type="text/javascript"></script>
        <!-- Controller includes -->
        
        <script src="../../controllers/modalbox.js" type="text/javascript"></script>
        <script src="../../controllers/utils.js" type="text/javascript"></script>
    </head>
    <body>
        <div id="mb-signal"></div>
        
        <script type="text/template" id="message-template">
            <div class="bar">
                <div class="votes">
                    <img src="../icons/up.png" class="thumb vote-up" />
                    <img src="../icons/down.png" class="thumb vote-down" />
                </div>
                <p><%= title %></p>
            </div>
            <iframe src="<%= link %>" frameborder="0" noresize="noresize">
        </script>
        
    </body>
    <script>
        
        var MessageView = Backbone.View.extend({
            events: {
                "click .vote-up": "up",
                "click .vote-down": "down",
                "click .skip": "skip",
            },
            
            id: "next",
            
            initialize: function () {
                _.bindAll(this, "become_current", "render", "up", "down", "skip", "prepare_next");
                this.model = messages[Math.floor(Math.random() * messages.length)]; // Get a next message
                messages = _.without(messages, this.model); // Remove it from the messages to be shown
            },
            
            become_current: function() {
                $(this.el).attr("id", "current");
                this.prepare_next();
            },
            
            render: function() {
                if(this.model) {
                    var object = {
                        link: this.model.main_link(),
                        title: this.model.attributes.title
                    };
                    $(this.el).html(_.template($('#message-template').html(), object));
                } else {
                    alert("Good job, there is no mor etraining to do right now. Please come back later!");
                    window.open('', '_self', '');
                    window.close();
                }
                return this
            },
            
            up: function() {
                this.model.vote_up();
                $(this.el).remove();
                next.become_current();
            },
            
            down: function() {
                this.model.vote_down();
                $(this.el).remove();
                next.become_current();
            },
            
            skip: function() {
                this.model.skip();
                $(this.el).remove();
                next.become_current();
            },
            
            prepare_next: function() {
                next = new MessageView({});
                $("body").append(next.render().el);
            }
            
        });

        var messages = [];
        var next = null;
        
        // $(window).bind('beforeunload', function() { 
        // });
        
        $(document).ready(function() {
            var archive = new Archive();
            archive.fetch({
                conditions: {
                    state: ["new", "training"]
                },
                success: function() {
                    messages = _.clone(archive.models); 
                    var current = new MessageView({});
                    $("body").append(current.render().el);
                    current.become_current();
                    
                }.bind(this),
                error: function(object, error) {
                    alert("Looks like there is no more training to do for now! Please come back often :)")
                }
            });
        });
        
    </script>
    
    
</html>