<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Growme"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/notification.css" />

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 

</head>
<body>
    <div id="message">
    </div>
    <!-- Templates -->
    <script type="text/template" id="notification-template">
		<h1><%= truncate(title , 42)%></h1>
		<p>
		<% if(source) {
		%>
			<span><%= source.title %></span>&nbspâ€”&nbsp
		<%
		} 
		%>
		<%= truncate(strip(summary), 96)%> </p>
    </script>
    
    <script>
	/* Creates the view and render */
    var MessageView = Backbone.View.extend({
        initialize: function() {
            _.bindAll(this, "render", "openViewer");
            $('body').click(this.openViewer);
        },
        
        render: function() {
            $(this.el).html(_.template($('#notification-template').html(), this.model.toJSON()));
            return this;
        },
        
        openViewer: function() {
            chrome.tabs.create({url:this.model.toJSON().links.alternate["text/html"][0].href, selected: false});
			chrome.extension.sendRequest({close: true}, function(response) {
                window.close();
          	});
        }
    });

    var currentView = new MessageView({el: "#message"});


	function showMessageForId(messageId) {
		message = new Message({'id': messageId})
        message.fetch();
		currentView.model = message;
        currentView.render();
	}

    $(document).ready(function() {
		window.focus(); // Put this alert in front!

		/* Makes sure we close this alert */
		/* Suspended for now. We should update live notifications, rather than delete them to leave room for others. */
        // setTimeout(function() {
        //     window.close();
        // }, 5000);

		

        chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
			if(request.notify) {
				showMessageForId(request.notify.message);
				window.focus(); // Put this alert in front!
			}
		});
    });
    </script>
</body>