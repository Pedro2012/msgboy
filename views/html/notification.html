<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Growme"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/notification.css" />


    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/messages.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/setting.js" type="text/javascript"></script> 
    <script src="../../models/settings.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

</head>
<body>
    <div id="message">
    </div>
    <!-- Templates -->
    <script type="text/template" id="notification-template">
            <h1><%= truncate(title , 42)%></h1>
            <p><span><%= source.title %></span>&nbspâ€”&nbsp <%= truncate(strip(summary), 96)%> </p>
    </script>
    
    <script>
    
    function getParameterByName( name ) {
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( window.location.href );
        if( results == null )
        return "";
        else
        return decodeURIComponent(results[1].replace(/\+/g, " "));
    }
    
    function truncate(text, len) {
        if (text.length > len) {
            text = text.substring(0, len);
            text = text.replace(/\w+$/, '');
            text  = text + "&hellip;"
        }
        return text;
    }

    function strip(html) {
        var tmp = document.createElement("DIV");
        tmp.innerHTML = html;
        return tmp.textContent||tmp.innerText;
    }
    
    $(document).ready(function() {
        var page = parseInt(getParameterByName("page"));
        var message_id = getParameterByName("message")
        console.log("Page : " + page + " - Message : " + message_id);
        var messages = new Messages(page);
         messages.fetch();
         var message = messages.get(message_id);

         var MessageView = Backbone.View.extend({
              events: {
              },

              initialize: function() {
                  _.bindAll(this, "render", "openViewer");
                  $('body').click(this.openViewer);
              },

              render: function() {
                  $(this.el).html(_.template($('#notification-template').html(), this.model.toJSON()));
                  return this;
              },

              openViewer: function() {
                  chrome.tabs.create({url:this.model.toJSON().links.alternate["text/html"][0].href, selected: false});
              }
          });

          view = new MessageView({model: message, el: "#message"});
          view.render();
    });
    </script>
</body>