<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Msgboy"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/notification.css" />

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <!-- Model includes -->
    <script src="../../models/database.js" type="text/javascript"></script> 
    <script src="../../models/message.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 

</head>
<body>
    <div id="message">
		<h2></h2>
		<p></p>
    </div>

    <script>

	// Google Analytics
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-22746593-1']);
	_gaq.push(['_trackPageview']);

	(function () {
	    var ga = document.createElement('script');
	    ga.type = 'text/javascript';
	    ga.async = true;
	    ga.src = 'https://ssl.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0];
	    s.parentNode.insertBefore(ga, s);
	})();

	//////////////////////////////////////////////////////////////////////////////////////
	//                                Hide Timer                                        //
	//////////////////////////////////////////////////////////////////////////////////////
	var started = false;
	var messages = [];

	//////////////////////////////////////////////////////////////////////////////////////
	//                                Views                                           //
	//////////////////////////////////////////////////////////////////////////////////////
	var MessageView = Backbone.View.extend({
	    initialize: function () {
	        _.bindAll(this, "render", "openViewer");
	        $('body').click(this.openViewer);
	    },

	    render: function () {
	        json = this.model.toJSON();
			this.$('h2').html(json.title)
            html = "";
			if (json.source) {
				html += "<span>" + json.source.title + "</span>&nbspâ€”&nbsp" + truncate(strip(json.summary), 128)
            } else {
				html += truncate(strip(json.summary), 128)
            }
			if(json.via) {
				html += "via <span>" + json.via + "</span>."
			}
    
	        this.$("p").html(html);
	    },

		openViewer: function () {
			// Open the message!
			this.model.save({
	            read_at: new Date().getTime(),
	            unread_at: 0
			});
			chrome.extension.sendRequest({
				"tab": {
					url: this.model.toJSON().links.alternate["text/html"][0].href,
					selected: false
				}
			}, function (response) {});
			
			chrome.extension.sendRequest({
				close: true
			}, function (response) {
				window.close();
			});
		}
	});

	//////////////////////////////////////////////////////////////////////////////////////
	//                                  Functions                                       //
	//////////////////////////////////////////////////////////////////////////////////////
	function showNextMessage() {
		messageId = messages.pop();
		if(!messageId) {
			window.close();
		}
		else {
			message = new Message({
				'id': messageId
			})
			message.fetch({
				success: function() {
					view.model = message;
					view.render();
					window.focus(); // Put this alert in front!
					window.setTimeout( function() {  
						showNextMessage() // After 5 seconds, show the next message.
					}, 5000);
				},
			});
		}
	}

	//////////////////////////////////////////////////////////////////////////////////////
	//                          Chrome Extension Handlers                               //
	//////////////////////////////////////////////////////////////////////////////////////
	$(document).ready(function () {
	    chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
	        if (request.notify && request.notify.message) {
				messages.push(request.notify.message);
				if(!started) {
					started = true // Initiate the loop.
					showNextMessage();
				}
	        }
	    });
	});

	//////////////////////////////////////////////////////////////////////////////////////
	//                                Main                                              //
	//////////////////////////////////////////////////////////////////////////////////////
	var view = new MessageView({
	    el: "#message"
	});
	
    </script>
</body>