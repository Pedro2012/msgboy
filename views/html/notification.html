<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Msgboy"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/notification.css" />

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 

</head>
<body>
    <div id="message">
		<h2></h2>
		<p></p>
    </div>

    <script>

	// Google Analytics
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-22746593-1']);
	_gaq.push(['_trackPageview']);

	(function () {
	    var ga = document.createElement('script');
	    ga.type = 'text/javascript';
	    ga.async = true;
	    ga.src = 'https://ssl.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0];
	    s.parentNode.insertBefore(ga, s);
	})();

	//////////////////////////////////////////////////////////////////////////////////////
	//                                Views                                           //
	//////////////////////////////////////////////////////////////////////////////////////
	var MessageView = Backbone.View.extend({
	    initialize: function () {
	        this.message_count = 0;
	        _.bindAll(this, "render", "openViewer");
	        $('body').click(this.openViewer);
	    },

	    render: function () {
	        json = this.model.toJSON();
	        if (this.message_count == 1) {
	            $(this.el + " h2").html(json.title)
	            if (json.source) {
	                $(this.el + " p").html("<span>" + json.source.title + "</span>&nbspâ€”&nbsp" + truncate(strip(json.summary), 128))
	            } else {
	                $(this.el + " p").html(truncate(strip(json.summary), 128))
	            }
	            return this;
	        } else {
	            $(this.el + " h2").html("You have " + this.message_count + " messages")
	            if (json.source) {
	                $(this.el + " p").html("including &ldquo;" + json.title + "&rdquo;, from <span>" + json.source.title + "</span")
	            } else {
	                $(this.el + " p").html("including &ldquo;" + json.title + "&rdquo;")
	            }
	            return this;

	        }
	    },

	    openViewer: function () {
	        if (this.message_count == 1) {
	            // Open the message!
	            this.model.set({
	                "read": true
	            });
	            this.model.save();
	            chrome.extension.sendRequest({
	                "tab": {
	                    url: this.model.toJSON().links.alternate["text/html"][0].href,
	                    selected: false
	                }
	            }, function (response) {});
	        } else {
	            // Open the inbox
	            chrome.extension.sendRequest({
	                "tab": {
	                    url: chrome.extension.getURL('/views/html/inbox.html'),
	                    selected: true
	                }
	            }, function (response) {});
	        }
	        chrome.extension.sendRequest({
	            close: true
	        }, function (response) {
	            window.close();
	        });
	    },

	    add_message: function (message) {
	        this.message_count++;
	        this.model = message;
	    }
	});

	//////////////////////////////////////////////////////////////////////////////////////
	//                                  Functions                                       //
	//////////////////////////////////////////////////////////////////////////////////////
	function showMessageForId(messageId) {
	    message = new Message({
	        'id': messageId
	    })
	    message.fetch();

	    view.add_message(message);
	    view.render();
	    window.focus(); // Put this alert in front!
	}

	//////////////////////////////////////////////////////////////////////////////////////
	//                          Chrome Extension Handlers                               //
	//////////////////////////////////////////////////////////////////////////////////////
	$(document).ready(function () {
	    chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
	        if (request.notify && request.notify.message) {
	            showMessageForId(request.notify.message);
	        }
	    });
	});

	//////////////////////////////////////////////////////////////////////////////////////
	//                                Main                                              //
	//////////////////////////////////////////////////////////////////////////////////////
	var view = new MessageView({
	    el: "#message"
	});

    </script>
</body>