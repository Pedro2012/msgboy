<!DOCTYPE HTML>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <title>
            Dashboard
        </title>
        <meta name="application-name" content="Msgboy" />
        <link rel="stylesheet" href="../css/style.css" />
        <link rel="stylesheet" href="../css/dashboard.css" />
        
        <!-- Lib includes -->
        <script src="../../lib/jquery/jquery.js" type="text/javascript"></script>
        <script src="../../lib/jquery/jquery.isotope.min.js" type="text/javascript"></script>
        <script src="../../lib/date.extensions.js" type="text/javascript"></script>
        <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script>
        <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script>
        <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script>

        <!-- Model includes -->
        <script src="../../models/database.js" type="text/javascript"></script>
        <script src="../../models/message.js" type="text/javascript"></script>
        <script src="../../models/archive.js" type="text/javascript"></script>
        <script src="../../models/inbox.js" type="text/javascript"></script>

        <!-- Controller includes -->
        <script src="../../controllers/utils.js" type="text/javascript"></script>
        
        <!-- Views includes -->
        <script src="../../views/js/message-view.js" type="text/javascript"></script>
        
    </head>
    
    
    <body>
        <div id="mb-signal"></div>
        
        <div id="archive">
            <div id="container" class="isotope">
                <!-- Messages will be added here when loaded -->
            </div>
        </div>
        
        <script>
            // Our overall InboxView is the top-level piece of UI.
            var ArchiveView = Backbone.View.extend({
                
                now: new Date().getTime(),
                days: 1,
                loaded: 20,
                to_load: 20,
                
                events: {
                },
                
                initialize: function() {
                    _.bindAll(this, 'render', 'delete_from_feed', 'show_new', 'complete_page', 'load_next');
                    $(document).scroll(this.complete_page);
                    
                    this.collection = new Archive();
                    
                    this.collection.comparator = function(message) {
                      return -message.attributes.created_at;
                    };
                    
                    this.collection.bind("add", this.show_new);
                    this.load_next();
                },

                complete_page: function() {
                    if ($("#container").height() < $(window).height()) {
                        // We should also pre-emptively load more pages if the document is shorter than the page.
                        this.load_next();
                    } else if ($(window).scrollTop() > $(document).height() - $(window).height() - 300) {
                        // We're close to the bottom. Let's load an additional page!
                        this.load_next();
                    }
                    else {
                        // Nothing to load
                    }
                },

                load_next: function() {
                    if(this.loaded == this.to_load) {
                        this.loaded = 0;
                        this.collection.next(this.to_load, {
                            created_at: [this.now, this.now - this.days * (1000 * 60 * 60 * 24)]
                        });
                    }
                },

                render: function() {
                    $(".message").remove(); // Cleanup
                },
                
                show_new: function(message) {
                    this.loaded++;
                    var view = new MessageView({
                        model: message
                    });
                    
                    view.bind("change", function() {
                        $('#container').isotope('reLayout');
                    })
                    
                    view.bind("rendered", function() {
                        this.complete_page();
                        $('#container').isotope('appended', $(view.el), function() {
                            $(view.el).show();
                        }.bind(this));
                    }.bind(this));
                    $(view.el).hide();
                    $("#container").append(view.el); // Adds the view in the document.
                    
                    view.bind("delete-from-feed", function(url) {
                        this.delete_from_feed(url);
                    }.bind(this));
                    
                    view.render(); // builds the HTML
                },
                
                delete_from_feed: function(feed) {
                    _.each(this.collection.models, function(model) {
                        if(model.attributes.feed == feed) {
                            model.view.remove();
                            model.destroy({
                                success: function() {
                                }
                            });
                        }
                    });
                },
            });
            
            $('#container').isotope({
              itemSelector : '.message',
              filter: '.brick-2 .brick-3 .brick-4',
              masonry: {
                 columnWidth: 10,
               },
            });
            
            var archiveView = null;
            var inbox = new Inbox({
                id: "1"
            });
            inbox.fetch({
                success: function() {
                    if(inbox.attributes.epoch > 0) {
                        archiveView = new ArchiveView({
                            el: "#archive",
                        });
                        archiveView.render();
                    } 
                    else {
                        chrome.tabs.create({
                            url: chrome.extension.getURL('/views/html/unsignup.html'),
                            selected: true
                        });
                    }
                },
                error: function() {
                    // There is no such inbox!
                    inbox.save({
                        epoch: new Date().getTime()
                    }, {
                        success: function() {
                            chrome.tabs.create({
                                url: chrome.extension.getURL('/views/html/unsignup.html'),
                                selected: true
                            });
                            window.close();
                        },
                        error: function() {
                            log("We could not create a database for msgboy.")
                        }
                    });
                }
            })
        </script>
    </body>

</html>