<!DOCTYPE HTML>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <title>Msgboy Dashboard</title>
        <meta name="application-name" content="Msgboy" />
        <link rel="stylesheet" href="../css/bootstrap.min.css" />
        <link rel="stylesheet" href="../css/header.css" />
        <link rel="stylesheet" href="../css/dashboard.css" />
        
        <!-- Error Reporting Code -->
        <!-- <script type="text/javascript" src="../../controllers/error_notifier.js"></script> -->
        
        <!-- Lib includes -->
        <script src="../../lib/jquery/jquery.js"></script>
        <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
        <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
        <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 
        <script src="../../lib/jquery/jquery.isotope.min.js" type="text/javascript"></script> 
        <script src="../../lib/date.format.js" type="text/javascript"></script> 
        <script src="../../lib/brain-0.3.5.min.js" type="text/javascript" ></script>
        <script src="../../lib/stemmer.js" type="text/javascript" ></script>

        <script src="../../lib/bootstrap/bootstrap-modal.js" type="text/javascript" ></script>

        <!-- Controller includes -->
        <script src="../../controllers/msgboy.js" type="text/javascript"></script> 
        <script src="../../controllers/events.js" type="text/javascript"></script> 
        <script src="../../controllers/utils.js" type="text/javascript"></script> 
        <script src="../../controllers/bayesian_filter.js" type="text/javascript"></script>
        
        <!-- Model includes -->
        <script src="../../models/database.js" type="text/javascript"></script> 
        <script src="../../models/message.js" type="text/javascript"></script> 
        <script src="../../models/archive.js" type="text/javascript"></script> 
        <script src="../../models/inbox.js" type="text/javascript"></script> 
        <script src="../../models/subscription.js" type="text/javascript"></script> 
        
        <!-- Views includes -->
        <script src="../../views/js/message-view.js" type="text/javascript"></script>
        <script src="../../views/js/archive-view.js" type="text/javascript"></script>
    </head>
    
    <body>
        <header class="topbar">
            <div class="fill">
                <div class="container">
                    <a href="dashboard.html"><h1>Msgboy</h1></a>
                    <ul class="nav">
                        <!-- <li class="active"><a href="dashboard.html">Dashboard</a></li> -->
                        <li><a href="options.html" class="options">Options</a></li>
                        <li><a href="help.html" class="help">Help</a></li>
                    </ul>
                    <div id="new_messages" data-unread="0">Hello World</div>
                </div>
            </div>
        </header>
        
        <div id="modal-share" class="modal backdrop fade">
            <div class="modal-header">
                <a href="#" class="close">Ã—</a>
                <h3>Share</h3>
            </div>
            <div class="modal-body">
                <label for="comment">Comment</label>
                <textarea class="xxlarge" id="comment" name="comment" rows="3"></textarea>
                <span class="help-block" id="character-count">0 characters</span>
                <a href="#" class="btn secondary share-ext twitter" data-service="twitter">Twitter</a>
                <a href="#" class="btn secondary share-ext facebook" data-service="facebook">Facebook</a>
            </div>
            <div class="modal-footer">
            </div>
        </div>
        
        <div id="archive">
            <div id="container" class="isotope">
                <!-- Messages will be added here when loaded -->
            </div>
        </div>

        <script type="text/javascript">
            Msgboy.bind("loaded", function () {
                var archive = new Archive();

                // When a message was voted-up
                archive.bind("up-ed", function (message) {
                    BayesianFilter.train_with_message(message);
                });
                
                archive.bind("down-ed", function (message) {
                    BayesianFilter.train_with_message(message)
                });

                $("#new_messages").click(function () {
                    // Refresh the page! Maybe it would actually be fancier to add the elements to the archive and then push them in front. TODO
                    window.location.reload(true);
                }) 

                var archiveView = new ArchiveView({
                    el: "#archive",
                    collection: archive,
                });

                chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
                    if (request.signature == "notify" && request.params) {
                        // Cool, we have a new message. Let's see if we add it to the top, or reload the page.
                        // Let's get the content of $("#new_messages")
                        var count = parseInt($("#new_messages").attr("data-unread"));
                        if (count) {
                            $("#new_messages").attr("data-unread", count + 1);
                            $("#new_messages").text("View " + (count + 1) + " new messages");
                        } else {
                            $("#new_messages").css("top","0");
                            $("#new_messages").attr("data-unread", "1");
                            $("#new_messages").text("View 1 new message");
                        }
                    }
                });
                
                var updateCountdown = function() {
                    var lngth = $("#comment").val().length;
                    $("#character-count").text(lngth + " characters");
                    if(lngth > 120) {
                        $(".btn.twitter").addClass("disabled");
                    }
                };
                
                $('#comment').change(updateCountdown);
                $('#comment').keyup(updateCountdown);
                
                $('.share-ext').click(function(e) {
                    var url = encodeURI($('#modal-share').data('url'));
                    var service = $(e.target).data('service');
                    var comment = encodeURI($('#comment').val());
                    chrome.extension.sendRequest({
                        signature: "tab",
                        params: {url: "http://msgboy.com/share/prepare?url=" + url + "&comment=" + comment + "&service=" + service, selected: true}
                    });
                    $('#modal-share').modal('hide');
                });
                
            });
            Msgboy.run();            
        </script>
    </body>
</html>