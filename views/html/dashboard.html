<!DOCTYPE HTML>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <title>Msgboy Dashboard</title>
        <meta name="application-name" content="Msgboy" />
        <link rel="stylesheet" href="../css/style.css" />
        <link rel="stylesheet" href="../css/dashboard.css" />
        
        <!-- Lib includes -->
        <script src="../../lib/jquery/jquery.js" type="text/javascript"></script> 
        <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
        <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
        <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 
        <script src="../../lib/jquery/jquery.isotope.min.js" type="text/javascript"></script> 
        <script src="../../lib/date.format.js" type="text/javascript"></script> 
    	<script src="../../lib/brain-0.3.5.min.js" type="text/javascript" ></script>
    	<script src="../../lib/stemmer.js" type="text/javascript" ></script>
    	
        <!-- Model includes -->
        <script src="../../models/database.js" type="text/javascript"></script> 
        <script src="../../models/message.js" type="text/javascript"></script> 
        <script src="../../models/archive.js" type="text/javascript"></script> 
        <script src="../../models/inbox.js" type="text/javascript"></script> 
        <script src="../../models/subscription.js" type="text/javascript"></script> 

        <!-- Controller includes -->
        <script src="../../controllers/msgboy.js" type="text/javascript"></script> 
        <script src="../../controllers/events.js" type="text/javascript"></script> 
        <script src="../../controllers/utils.js" type="text/javascript"></script> 
        <script src="../../controllers/bayesian_filter.js" type="text/javascript"></script> 
        
        <!-- Views includes -->
        <script src="../../views/js/message-view.js" type="text/javascript"></script>
        <script src="../../views/js/archive-view.js" type="text/javascript"></script>
        
    </head>
    
    
    <body>
        
        <header>
            <h1>msgboy</h1>
            <h2>|&nbsp;&nbsp;Dashboard&nbsp;&nbsp;|</h2>
            <a href="options.html" class="options">Options</a><a href="splash.html" class="help">Help</a>
        </header>
        

        <div id="archive">
            <div id="new_messages"></div>
            <div id="container" class="isotope">
                <!-- Messages will be added here when loaded -->
            </div>
        </div>
        
        <script type="text/javascript">
        $(document).ready(function () {

            $('#container').isotope({
                itemSelector: '.message',
                filter: '.brick-1 .brick-2 .brick-3 .brick-4',
                masonry: {
                    columnWidth: 10,
                },
            });

            var archive = new Archive();

            // When a message was voted-up
            archive.bind("up-ed", function (message) {
                BayesianFilter.train_with_message(message);
                $('#container').isotope('reLayout');
            });

            // When a message was voted-down
            archive.bind("down-ed", function (message) {
                BayesianFilter.train_with_message(message);
                $('#container').isotope('reLayout');
            });

            $("#new_messages").click(function() {
                // Refresh the page!
                window.location.reload(true);
            }) 

            var archiveView = new ArchiveView({
                el: "#archive",
                collection: archive,
            });
            archiveView.render();

            chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
                if (request.signature == "notify" && request.params) {
                    // Cool, we have a new message. Let's see if we add it to the top, or reload the page.
                    // Let's get the content of $("#new_messages")
                    if($("#new_messages").text()) {
                        $("#new_messages").text(parseInt($("#new_messages").text()) + 1 + " new messages");
                    } else {
                        $("#new_messages").show();
                        $("#new_messages").text("1 new message");
                    }
                }
            });

        });
        </script>
    </body>

</html>