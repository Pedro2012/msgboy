<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Log In</title>
    <meta name="application-name" content="Msgboy"/>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/login.css" />
    
    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script> 
    <script src="../../lib/date.extensions.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/database.js" type="text/javascript"></script> 
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
</head>
<body>
    <div id="login">
        <h1>Login</h1>
        
        <form accept-charset="UTF-8" id="new_session">
            <table>
                <tr><td><label for="user_username">Username</label></td><td><input id="user_username" name="user[username]" size="30" type="text" /> </td></tr>
                <tr><td><label for="user_password">Password</label></td><td><input id="user_password" name="user[password]" size="30" type="password" value="" /> </td></tr>
                <tr><td><a href="http://msgboy.com/passwords/new">Forgot password?</a></td><td><input id="user_submit" name="commit" type="submit" value="Log in" /></td></tr>
            </table>
        </form>
        <p id="connectionStatus"></p>
    </div>

    <script>
    var base = "http://msgboy.com"

    var NewUserFormView = Backbone.View.extend({
        events: {
            "submit": "login",
        },

        initialize: function() {
            _.bindAll(this, "render");
        },

        render: function() {
        },

        login: function() {
            chrome.extension.sendRequest({
                "settings": {
                    "set": ["jid", $("#user_username").val()]
                }
            }, function (response) {
                chrome.extension.sendRequest({
                    "settings": {
                        "set": ["password", $("#user_password").val()]
                    }
                }, function (response) {
                    // Now we need to tell the msgboy to connect and then redirect to options!
                    chrome.extension.sendRequest({
                        connect: true
                    }, function (response) {
                        chrome.extension.connect({
                            name: "connection"
                        }).onMessage.addListener(function (msg) {
                            if (msg == "Msgboy is connected.") {
                                // Cool, we're connected...
                                window.location = chrome.extension.getURL('/views/html/plugins.html') // We redirect the user 
                            } else {
                                // We should show this to the user!
                                $('#connectionStatus').text(msg);
                            }
                        });
                    }.bind(this));
                }.bind(this));
            }.bind(this));
            return false
        }

    });

    var view = new NewUserFormView({
        el: "#new_session"
    });

    </script>
</body>
</html>
