<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Growme"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/style.css" />


    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/messages.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/setting.js" type="text/javascript"></script> 
    <script src="../../models/settings.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

</head>

<body>
    <div id="settings">
        <h2>Account</h2>
        Login : <input type="text" id="login"><br />
        Password : <input type="Password" id="password"><br />
        <h2>Import 3rd party Subscriptions</h2>
        Google Reader<input type="checkbox" id="syncGoogleReader"><br />
        <h2>Developer</h2>
        Debug <input type="checkbox" id="debug"></input><br />
        Raw Debug <input type="checkbox" id="rawDebug"></input><br />
    </div>
    
    <script>
    var jid = localStorage.getItem("currentJid");
    var inbox = new Inbox({id: jid});
    
    // Our overall InboxView is the top-level piece of UI.
    var InboxView = Backbone.View.extend({
        current_page_number: null,
        events: {
            "change #login" : "login",
            "change #password" : "password",
            "change #debug" : "debug",
            "change #rawDebug" : "rawDebug",
            "change #syncGoogleReader" : "syncGoogleReader"
        },
        
        initialize: function() {
            _.bindAll(this, 'render', 'debug', 'rawDebug', 'syncGoogleReader', '', '', '');
            this.render();
        },

        render: function() {
            if(this.model.id) {
                this.$("#login").val(this.model.id.split("@")[0]);
                this.$("#debug").attr('checked', this.model.get("settings.debug"));
                this.$("#rawDebug").attr('checked', this.model.get("settings.rawDebug"));
                this.$("#syncGoogleReader").attr('checked', this.model.get("settings.syncGoogleReader"));
                this.$("#password").val(this.model.get("settings.password"));
            } 
            else {
                // This must be an empty inbox.
            }
        },
        
        debug: function() {
            this.model.set({"settings.debug": this.$("#debug").attr('checked')})
            this.model.save();
        },
        
        rawDebug: function() {
            this.model.set({"settings.rawDebug": this.$("#rawDebug").attr('checked')})
            this.model.save();
        },
        
        syncGoogleReader: function() {
            this.model.set({"settings.syncGoogleReader": this.$("#syncGoogleReader").attr('checked')})
            this.model.save();
        },
        
        // Fine. What now? We saved the login. We need to save the jid too. As it's used to retrieve the inbox object too!
        login: function() {
            if(this.model.jid != this.$("#login").val()) {
                var inbox = new Inbox({id: this.$("#login").val() + "@superfeedr.com"});
                inbox.save();
                this.model = inbox;
                localStorage.setItem("currentJid", inbox.id);
                this.render(); // We re-render.
            }
        },
        
        password: function() {
            this.model.set({"settings.password": this.$("#password").val()})
            this.model.save();
        }
   });

    var inboxView = new InboxView({el: "#settings", model: inbox});

    </script>
    
</body>
</html>