<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Growme"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
    <script src="../../controllers/site_plugins.js" type="text/javascript"></script> 

</head>

<body>
    <div id="nav">
        <span class="inbox">Inbox</span>
        <span class="settings">Settings</span>
    </div>
    <script>
    $("#nav span.inbox").click(function() {
        window.location = chrome.extension.getURL('/views/html/inbox.html')
        return false;
    })
    $("#nav span.settings").click(function() {
        window.location = chrome.extension.getURL('/views/html/options.html')
        return false;
    })
    </script>
    <div id="settings">
        <h2>Account</h2>
        Login : <input type="text" id="jid"><br />
        Password : <input type="Password" id="password"><br />
        <h2>Plugins</h2>
		<p>Make sure you are logged in these services before you check the import box.</p>
        <div id="plugins">
        </div>
        <span id="saved">Saved</span>
    </div>
    
    <script type="text/template" id="plugin-template">
    <span class="plugin" >
        <input type="checkbox" name="<%= name %>" id="<%= nameToId(name) %>" /> <%= name %>
    </span>
    </script>
    
    <script>

    
    var inbox = new Inbox();
    
    // Our overall InboxView is the top-level piece of UI.
    var InboxView = Backbone.View.extend({
        events: {
            "change #settings #jid" : "jid",
            "change #settings #password" : "password",
            "change #plugins span.plugin input" : "plugin",
        },
        
        initialize: function() {
            _.bindAll(this, 'render');
            this.model.bind('change', function() {
                $("#settings #saved").show();
                $("#settings #saved").fadeOut("slow")
            });
            
            this.render();
        },
   
        render: function() {
            if(this.model.id) {
                for( var i in this.model.attributes) {
                    if(this.model.attributes[i] == true || this.model.attributes[i] == false) {
                        $("#"+i.split(".").join(" #")).attr('checked', this.model.attributes[i]);
                    }
                    else {
                        $("#"+i.split(".").join(" #")).val(this.model.attributes[i]);
                    }
                }
            } 
            else {
                // This must be an empty inbox.
            }
        },
        
        // Fine. What now? We saved the login. We need to save the jid too. As it's used to retrieve the inbox object too!
        jid: function() {
            this.model.set({"settings.jid": this.$("#jid").val()})
            this.model.save();
            chrome.extension.sendRequest({"connect": true}, function(response) {
               // Nothing specific 
            });
        },
        
        password: function() {
            this.model.set({"settings.password": this.$("#password").val()})
            this.model.save();
            chrome.extension.sendRequest({"connect": true}, function(response) {
               // Nothing specific 
            });
        },
        
        plugin: function(event) {
            element = $(event.target);
            setting = "settings.plugins." + nameToId(element.attr("name"));
            settings = {}
            settings[setting] = element.is(':checked')
            this.model.set(settings)
            this.model.save();
        }
   });
   
    var PluginView = Backbone.View.extend({
        initialize: function() {
            _.each(Plugins.all, function(plugin) {
                element = $(_.template($('#plugin-template').html(), plugin))
                element.change(function() {
                    if($(this).find("input").is(':checked')) {
                        // When clicked. We should just import the feeds in the back!
                        plugin.importSubscriptions();
                    }
                })
                $("#plugins").append(element);
            });
        }
    })
    
    var pluginView = new PluginView({el: "#plugins"});
    var inboxView = new InboxView({el: "#settings", model: inbox});
    

    </script>
    
</body>
</html>