<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Growme"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
    <script src="../../controllers/site_plugins.js" type="text/javascript"></script> 

</head>

<body>
    <div id="nav">
        <span class="inbox">Inbox</span>
        <span class="settings">Settings</span>
    </div>
    <div id="settings">
        <h2>Account</h2>
        Login : <input type="text" id="jid"><br />
        Password : <input type="Password" id="password"><br />
		<input id="reconnect" type="button" value="Connect!" />
		<p id="connectionStatus"></p>
        <div id="plugins" style="display:none">
	        <h2>Plugins</h2>
			<p>Make sure you are logged in these services before you check the import box.</p>
        </div>
        <span id="saved">Saved</span>
		<input id="reset" type="button" value="Reset" />
    </div>
    
    <script type="text/template" id="plugin-template">
    <span class="plugin" >
        <input type="checkbox" name="<%= name %>" id="<%= nameToId(name) %>" /> <%= name %>
    </span>
    </script>
    
    <script>

    $("#nav span.inbox").click(function() {
        window.location = chrome.extension.getURL('/views/html/inbox.html')
        return false;
    })
    $("#nav span.settings").click(function() {
        window.location = chrome.extension.getURL('/views/html/options.html')
        return false;
    })

    chrome.extension.connect({name: "connection"}).onMessage.addListener(function(msg) {
		$('#connectionStatus').text(msg);
		if(msg == "Superfeedr is connected.") {
			// Good, we can show the plugins.
			$("#plugins").show();
		}
		else {
			// Bad, we can't show the plugins... but let's allow the user to reconnect!
			$("#plugins").hide();
		}
    });
    
    // Our overall InboxView is the top-level piece of UI.
    var InboxView = Backbone.View.extend({
        events: {
            "change #settings #jid" : "jid",
            "change #settings #password" : "password",
			"click #settings #reconnect" : "reconnect",
			"click #settings #reset" : "reset"
        },
        
        initialize: function() {
            _.bindAll(this, 'render');
            this.render();
        },
   
        render: function() {
			chrome.extension.sendRequest({"settings": {"get": ["jid"]}}, function(response) {
				$("#jid").val(response.value);
		    });
			chrome.extension.sendRequest({"settings": {"get": ["password"]}}, function(response) {
				$("#password").val(response.value);
		    });

        },
        
        // Fine. What now? We saved the login. We need to save the jid too. As it's used to retrieve the inbox object too!
        jid: function() {
		    chrome.extension.sendRequest({"settings": {"set" : ["jid",this.$("#jid").val()]}}, function(response) {
		    });
        },
        
        password: function() {
		    chrome.extension.sendRequest({"settings": {"set" : ["password",this.$("#password").val()]}}, function(response) {
		    });
        },
        
		reconnect: function() {
			chrome.extension.sendRequest({connect: true}, function(response) {
			});
		},
		
		reset: function() {
			if(confirm("Are you sure? There is no way back and all your data will be deleted!")) {
				chrome.extension.sendRequest({reset: true}, function(response) {
				});
			}
		}
   });
   
    var PluginView = Backbone.View.extend({
        initialize: function() {
            _.each(Plugins.all, function(plugin) {
                element = $(_.template($('#plugin-template').html(), plugin))
				
				chrome.extension.sendRequest({"settings": {"get": ["plugins." + nameToId(plugin.name)]}}, function(response) {
					$("#"+nameToId(plugin.name)).attr('checked', response.value);
			    });


                element.change(function() {
                    if($(this).find("input").is(':checked')) {
                        // When clicked. We should just import the feeds in the back!
						chrome.extension.sendRequest({"settings": {"set" : ["plugins." + nameToId(plugin.name), true]}}, function(response) {
					    });
                        plugin.importSubscriptions();
					}
					else {
						chrome.extension.sendRequest({"settings": {"set" : ["plugins." + nameToId(plugin.name), false]}}, function(response) {
					    });
                    }
                })
                $("#plugins").append(element);
            });
        }
    })
    
    var pluginView = new PluginView({el: "#plugins"});
    var inboxView = new InboxView({el: "#settings"});
    

    </script>
    
</body>
</html>