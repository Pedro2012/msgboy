<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Growme</title>
    <meta name="application-name" content="Growme"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    
    <!-- Lib includes -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 
    <script src="../../lib/date.format.js" type="text/javascript"></script> 
    
    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/strophe.superfeedr.js" type="text/javascript"></script> 
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
    
</head>
<body>
    
    <!-- Less go! -->
    <script language='javascript'>
        
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                                Objects                                           //
        //////////////////////////////////////////////////////////////////////////////////////
        var inbox                   = new Inbox();
        var logEnabled              = false; 
        var currentConnectionStatus = {};
        var boshService             = 'http://superfeedr.com/http-bind/'
        var connection              = new Strophe.Connection(boshService);
        var password                = "";
        var jid                     = "";
        
        currentConnectionStatus['msg'] = ""
        _.extend(currentConnectionStatus, Backbone.Events);
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                                  Functions                                       //
        //////////////////////////////////////////////////////////////////////////////////////
        
        // Creates the HTML5 notification
        function notify(message) {
            url = chrome.extension.getURL('/views/html/notification.html?message='+message.toJSON().id);
            webkitNotification = window.webkitNotifications.createHTMLNotification(url);
            webkitNotification.show();
        }
        
        // Logs messages to the console
        function log(msg) {
            if(logEnabled) {
                console.log(msg);
            }
        }
        
        // Handles XMPP Connections
        function onConnect(status) {
            var msg = currentConnectionStatus['msg'];
            if (status == Strophe.Status.CONNECTING) {
                msg = 'Superfeedr is connecting.';
            } else if (status == Strophe.Status.CONNFAIL) {
                msg = 'Superfeedr failed to connect.';
                connect();
            } else if (status == Strophe.Status.DISCONNECTING) {
                msg = 'Superfeedr is disconnecting.';
            } else if (status == Strophe.Status.DISCONNECTED) {
                msg = 'Superfeedr is disconnected.';
                connect();
            } else if (status == Strophe.Status.CONNECTED) {
                msg = 'Superfeedr is connected.';
            }
            currentConnectionStatus['msg'] = msg;
            currentConnectionStatus.trigger("change", msg);
            log(msg);
        } // function onConnect
        
        
        // Connects the XMPP Client
        function connect() {
            password = inbox.get("settings.password");
            jid = inbox.get("settings.jid") + "@superfeedr.com";

            connection.rawInput = function(data) {
                log('RECV: ' + data);
            };
            connection.rawOutput = function(data) {
                log('SENT: ' + data);
            };
            connection.connect(jid, password, onConnect);

            connection.superfeedr.addNotificationHandler(function(msg) {
                message = inbox.addMessage(msg);
                notify(message);
            }); //connection.superfeedr.addNotificationHandler            
        }
        
        // Disconnects to reconnect.
        function reconnect() {
            connection.disconnect();
        }
        
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                          Chrome Extension Handlers                               //
        //////////////////////////////////////////////////////////////////////////////////////
        
        // Adds a listener on the connection status to be used in the bookmark
        chrome.extension.onConnect.addListener(function(port) {
            port.postMessage(currentConnectionStatus.msg);
            currentConnectionStatus.bind("change", function(msg) {
                port.postMessage(msg);
            });
        });
        
        // Handler messages
        chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
            if(request.settings) { // Settings
                if(request.settings.get) { // get them
                    sendResponse({value: inbox.get("settings."+request.settings.get[0]) || 0 });
                }
                else if(request.settings.set) { // Set them
                    attrs = {};
                    attrs["settings."+request.settings.set[0]] = request.settings.set[1];
                    inbox.set(attrs);
                    sendResponse({value: true});
                }
            }
            else if (request.tab) { // Open tab
                chrome.tabs.create(request.tab);
            }
            else if (request.add) { // Add a new message to the inbox.
                message = inbox.addMessage(request.add);
                notify(message);
                sendResponse({value: message});
            }
            else if(request.subscribe) { // Subscribes to more feeds
                connection.superfeedr.subscribe(request.subscribe, function(result) {
                    var atom_id = "tag:superfeedr.com," + (new Date()).format("yyyy-mm-dd") + "/internal/subscriptions/" + escape(request.subscribe);
                   var msg = {
                      atom_id: atom_id,
                      title: "New subscription",
                      summary: "Successfully subscribed to " + request.subscribe,
                      read:true,
                      starred:false,
                      content : null,
                      links: {},
                      source: null
                    };
                    message = inbox.addMessage(msg);
                    notify(message);
                    sendResponse({value: result});
                })
            }
            else if(request.unsubscribe) { // Unsubscribes from feeds
                connection.superfeedr.unsubscribe(request.unsubscribe, function(result) {
                    sendResponse({value: result});
                })
            }
            else if(request.connect) {
                reconnect();
                sendResponse({value: true});
            }
        });
        
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                                        Main                                      //
        //////////////////////////////////////////////////////////////////////////////////////
        if(inbox.get("settings.jid")) { // If the settings are entered.
            connect();
        }
        else {
            // We need the user to enter its settings
            chrome.tabs.create({url:chrome.extension.getURL('/views/html/options.html'), selected: true});
        }

    </script>
</body>