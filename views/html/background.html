<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Growme</title>
    <meta name="application-name" content="Growme"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="/css/notification.css" />
</head>
<body>
    <script src="/lib/strophejs/src/base64.js" type="text/javascript"></script> 
    <script src="/lib/strophejs/src/md5.js" type="text/javascript"></script> 
    <script src="/lib/strophejs/src/core.js" type="text/javascript"></script> 
    <script src="/lib/strophejs-plugins/pubsub/strophe.pubsub.js" type="text/javascript"></script> 
    <script language='javascript'>

    var BOSH_SERVICE = 'http://superfeedr.com/http-bind/'
    var connection = null;


    function notify(notification) {
        var webkitNotification = null;
        if(notification.entry) {
            webkitNotification  = webkitNotifications.createHTMLNotification(chrome.extension.getURL('/templates/notification.html?entry='+notification.entry));
        }
        else {
            webkitNotification = webkitNotifications.createNotification(
                notification.icon || '/icons/icon.png', 
                notification.title,  
                notification.content  
                ); // Later, see if it doesn't make sense to create an HTML notification, as this will leave a greater margin for formatting purposes. chrome-extension are authorized. We just need to make sure we can dynamically create files. (We can also generate it with JS probably!)
            };

            webkitNotification.ondisplay = function() {
                setTimeout(function() {
                    webkitNotification.cancel();
                    }, 5000);
                }
                webkitNotification.show();
            }

            function rawLog(msg) {
                var defaultViewTabUrl= chrome.extension.getURL('/templates/default.html');
                //Look through all the pages in this extension to find one we can use.
                var views = chrome.extension.getViews();
                for (var i = 0; i < views.length; i++) {
                    var view = views[i];
                    if (view.location.href == defaultViewTabUrl) {
                        view.showRawLog(msg);
                        break; //we're done
                    }
                }
            }

            function log(msg) {
                var defaultViewTabUrl= chrome.extension.getURL('/templates/default.html');
                //Look through all the pages in this extension to find one we can use.
                var views = chrome.extension.getViews();
                for (var i = 0; i < views.length; i++) {
                    var view = views[i];
                    if (view.location.href == defaultViewTabUrl) {
                        view.showLog(msg);
                        break; //we're done
                    }
                }
            }

            function rawInput(data) {
                if(localStorage.getItem("raw_debug") == "true") {
                    rawLog('RECV: ' + data);
                }
            }

            function rawOutput(data) {
                if(localStorage.getItem("raw_debug") == "true") {
                    rawLog('SENT: ' + data);
                }
            }

            function onConnect(status) {
                if (status == Strophe.Status.CONNECTING) {
                    log('Strophe is connecting.');
                } else if (status == Strophe.Status.CONNFAIL) {
                    log('Strophe failed to connect.');
                    $('#connect').get(0).value = 'connect';
                } else if (status == Strophe.Status.DISCONNECTING) {
                    log('Strophe is disconnecting.');
                } else if (status == Strophe.Status.DISCONNECTED) {
                    log('Strophe is disconnected.');
                    notify({
                        title: 'Disconnected',
                        content: 'Reconnecting...'
                    });
                    connection.connect("subscriber@superfeedr.com", "subscriber", onConnect);
                } else if (status == Strophe.Status.CONNECTED) {
                    log('Strophe is connected.');
                    notify({
                        title: 'Connected',
                        content: 'Welcome to the future!'
                    });
                }
            }

/* 
onMessage(message)
Handler for messages. For some reason, adding a filter on the from firehoser.superfeedr.com fails in addHandler.
This will just split the message, and extract what's valuable, like the title and a small excerpt.
*/
function onMessage(msg) {
    if(msg.getAttribute('from') == "firehoser.superfeedr.com") {
        var entries = extractAtomEntriesFromXml(msg)
        for( i=0; i<entries.length; i++) {
            var entry = entries[i];
            var entry_key = storeEntry(entry);
            notify({entry:  entry_key});
        }
    }
    return true; // We must return true to keep the handler active!
}

/*
Converts Atom/XML into a JSON object.
*/
function extractAtomEntriesFromXml(msg) {
    var result = []
    var entries = msg.getElementsByTagName("entry");
    var status = msg.getElementsByTagName("status")[0];
    var source = {
        title: Strophe.getText(status.getElementsByTagName("title")[0])
    }
    for( i=0; i<entries.length; i++) {
        var atom = entries[i];
        var links = {};
        var atom_links = atom.getElementsByTagName("link");
        for(j=0; j<atom_links.length; j++) {
            var link = atom_links[j];
            l = {
                href: link.getAttribute("href"),
                rel: link.getAttribute("rel"),
                title: link.getAttribute("title"),
                type: link.getAttribute("type")
            };
            links[link.getAttribute("rel")] = (links[link.getAttribute("rel")] ? links[link.getAttribute("rel")] : []);
            links[link.getAttribute("rel")].push(l);
        }
        result.push({
            id: Strophe.getText(atom.getElementsByTagName("id")[0]),
            published: Strophe.getText(atom.getElementsByTagName("published")[0]),
            updated: Strophe.getText(atom.getElementsByTagName("updated")[0]),
            title: Strophe.getText(atom.getElementsByTagName("title")[0]),
            summary: Strophe.getText(atom.getElementsByTagName("summary")[0]),
            content: Strophe.getText(atom.getElementsByTagName("content")[0]),
            links: links,
            source: source
        });
    }
    return result;
}

/*
Not only does it store the object, but also adds it to a page!
*/
function storeEntry(entry) {
    var entry_key = MD5.hexdigest(entry.id);
    if(!localStorage.getItem(entry_key)) {
        localStorage.setItem(entry_key, JSON.stringify(entry)); /* Stores the object first!*/
        var current_page_index = parseInt(localStorage.getItem("current_page_index") || 1);
        var current_page = JSON.parse(localStorage.getItem("page-" + current_page_index)) || [];
        if(current_page.length > 20) {
            current_page_index = current_page_index + 1;
            var current_page = [];
        } // We make sure we never store more than 20 items per page.
        current_page.push(entry_key);
        sessionStorage.removeItem("current_page_index");
        localStorage.setItem("current_page_index", current_page_index);
        localStorage.removeItem("page-" + current_page_index);
        localStorage.setItem("page-" + current_page_index, JSON.stringify(current_page));    
        return(entry_key);
    }
    else {
        return false; // Looks like it's a dupe!
    }
}

connection = new Strophe.Connection(BOSH_SERVICE);
connection.rawInput = rawInput;
connection.rawOutput = rawOutput;
connection.connect("subscriber@superfeedr.com", "subscriber", onConnect);
connection.addHandler(onMessage, null, 'message', null, null,  null); 

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
    if(request.localstorage) {
        if(request.set) {
            sendResponse({value: localStorage[request.localstorage] = request.set});
        }
        else {
            sendResponse({value: localStorage[request.localstorage]});
        }
    }
    else if (request.msg == "subscribe") {
        // Great, we have a feed and the user wants to subscribe!
        connection.pubsub.subscribe(connection.jid, 'firehoser.superfeedr.com', request.feed.href,null,null,function(stanza) {
            notify({
                title: 'Subscribed',
                content: "You will now get updates from '" + request.feed.title + "'"
            });
        })
    }
    else if (request.msg == "list") {
        // List subscriptions
        var stanza_id = connection.getUniqueId("subscribenode");
        var sub = $iq({from:connection.jid, to:'firehoser.superfeedr.com', type:'get', id:stanza_id});
        sub.c('pubsub', { xmlns:Strophe.NS.PUBSUB }).c('subscriptions', {jid:Strophe.getBareJidFromJid(connection.jid), 'xmlns:superfeedr': "http://superfeedr.com/xmpp-pubsub-ext", 'superfeedr:page': request.page});    
        alert(Strophe.serialize(sub));
        connection.addHandler(function(response) {  
            <iq xmlns='jabber:client' from='firehoser.superfeedr.com' to='subscriber@superfeedr.com/10989473301298602209553095' type='result' id='882:subscribenode'>
              <pubsub xmlns='http://jabber.org/protocol/pubsub' xmlns:superfeedr='http://superfeedr.com/xmpp-pubsub-ext'>
                <subscriptions superfeedr:page='1'>
                  <subscription node='http://blog.aweissman.com/feeds/posts/default' jid='subscriber@superfeedr.com' subscription='subscribed' superfeedr:digest='false' superfeedr:format='atom'>
                    <superfeedr:status>
                      <superfeedr:http code='200'>97639B in 0.319894116s, 0/25 new entries</superfeedr:http>
                      <superfeedr:next_fetch>2011-02-25T06:45:45+00:00</superfeedr:next_fetch>
                      <superfeedr:period>64800</superfeedr:period>
                      <superfeedr:last_fetch>2011-02-24T12:45:45+00:00</superfeedr:last_fetch>
                      <superfeedr:last_parse>2011-02-24T12:45:45+00:00</superfeedr:last_parse>
                      <superfeedr:last_maintenance_at>2011-02-24T12:45:45+00:00</superfeedr:last_maintenance_at>
                    </superfeedr:status>
                  </subscription>
                  <subscription node='http://julienge.tumblr.com/rss' jid='subscriber@superfeedr.com' subscription='subscribed' superfeedr:digest='false' superfeedr:format='atom'>
                    <superfeedr:status>
                      <superfeedr:http code='200'>986B in 0.173751103s, 2/2 new entries</superfeedr:http>
                      <superfeedr:next_fetch>2011-02-25T16:02:09+00:00</superfeedr:next_fetch>
                      <superfeedr:period>64800</superfeedr:period>
               ...com/atom.xml' jid='subscriber@superfeedr.com' subscription='subscribed' superfeedr:digest='false' superfeedr:format='atom'>
                    <superfeedr:status>
                      <superfeedr:http code='304'>Content not modified</superfeedr:http>
                      <superfeedr:next_fetch>2011-02-25T02:59:36+00:00</superfeedr:next_fetch>
                      <superfeedr:period>900</superfeedr:period>
                      <superfeedr:last_fetch>2011-02-25T02:44:36+00:00</superfeedr:last_fetch>
                      <superfeedr:last_parse>2011-02-24T20:46:09+00:00</superfeedr:last_parse>
                      <superfeedr:last_maintenance_at>2011-02-22T21:47:00+00:00</superfeedr:last_maintenance_at>
                    </superfeedr:status>
                  </subscription>
                  <subscription node='http://julien51.status.net/api/statuses/user_timeline/1.atom' jid='subscriber@superfeedr.com' subscription='subscribed' superfeedr:digest='false' superfeedr:format='atom'>
                    <superfeedr:status>
                      <superfeedr:http code='200'>9891B in 3.452857942s, 1/6 new entries</superfeedr:http>
                      <superfeedr:next_fetch>2011-02-25T14:48:27+00:00</superfeedr:next_fetch>
                      <superfeedr:period>64800</superfeedr:period>
                      <superfeedr:last_fetch>2011-02-24T20:48:27+00:00</superfeedr:last_fetch>
                      <superfeedr:last_parse>2011-02-24T20:48:27+00:00</superfeedr:last_parse>
                      <superfeedr:last_maintenance_at>2011-02-24T15:19:37+00:00</superfeedr:last_maintenance_at>
                    </superfeedr:status>
                  </subscription>
                </subscriptions>
              </pubsub>
            </iq>
            return false; // Unregisters
        },
        null,
        'iq',
        null,
        stanza_id,
        null);
        connection.send(sub.tree());
    }
});

    </script>
</body>