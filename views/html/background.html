<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Growme</title>
    <meta name="application-name" content="Growme"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    
    <!-- Lib includes -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/websocket.js" type="text/javascript"></script> 
    <script src="../../lib/date.format.js" type="text/javascript"></script> 
    
    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/strophe.superfeedr.js" type="text/javascript"></script> 
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
    
</head>
<body>
    
    <!-- Less go! -->
    <script language='javascript'>
        
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                                Objects                                           //
        //////////////////////////////////////////////////////////////////////////////////////
        var inbox                   = new Inbox();
        var logEnabled              = true; 
        var currentConnectionStatus = {};
        var websocketEndpoint       = 'ws://xmpp7.superfeedr.com:5288/ws-xmpp'
		var connection				= new Strophe.Connection({protocol: new Strophe.Websocket(websocketEndpoint)});
        var password                = "";
        var jid                     = "";
		var autoReconnect			= false;
		
		connection.rawInput = function(data) {
            log('RECV: ' + data);
        };
        connection.rawOutput = function(data) {
            log('SENT: ' + data);
        };

        connection.superfeedr.addNotificationHandler(function(msg) {
            message = inbox.addMessage(msg);
            notify(message);
        }); //connection.superfeedr.addNotificationHandler 
        
        currentConnectionStatus['msg'] = ""
        _.extend(currentConnectionStatus, Backbone.Events);
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                                  Functions                                       //
        //////////////////////////////////////////////////////////////////////////////////////
        
        // Creates the HTML5 notification
        function notify(message) {
            url = chrome.extension.getURL('/views/html/notification.html?message='+message.toJSON().id);
            webkitNotification = window.webkitNotifications.createHTMLNotification(url);
            webkitNotification.show();
        }
        
        // Logs messages to the console
        function log(msg) {
            if(logEnabled) {
                console.log(msg);
            }
        }
        
        // Handles XMPP Connections
        function onConnect(status) {	
            var msg = currentConnectionStatus['msg'];
            if (status == Strophe.Status.CONNECTING) {
                msg = 'Superfeedr is connecting.';
            } else if (status == Strophe.Status.CONNFAIL) {
                msg = 'Superfeedr failed to connect.';
                if(autoReconnect) 
					connect();
			} else if(status == Strophe.Status.AUTHFAIL) {
				msg = 'Superfeedr couldn\'t authenticate. Please check your credentials';
				autoReconnect = false
            } else if (status == Strophe.Status.DISCONNECTING) {
                msg = 'Superfeedr is disconnecting.';
            } else if (status == Strophe.Status.DISCONNECTED) {
                msg = 'Superfeedr is disconnected.';
                if(autoReconnect) 
					connect();
            } else if (status == Strophe.Status.CONNECTED) {
				autoReconnect = true; // Set autoReconnect to true only when we've been connected :)
                msg = 'Superfeedr is connected.';
				connection.send($pres());// Send presence!
            }
            currentConnectionStatus['msg'] = msg;
            currentConnectionStatus.trigger("change", msg);
            log(msg);
        } // function onConnect
        
        
        // Connects the XMPP Client
        function connect() {
			autoReconnect	= false;
            password 		= inbox.get("settings.password");
            jid 			= inbox.get("settings.jid") + "@superfeedr.com";

            connection.connect(jid, password, onConnect);
        }
        
        // Disconnects to reconnect.
        function reconnect() {
			autoReconnect = false; // Let's remove the autoReconnect for now.
			if(connection.status == Strophe.Status.CONNECTED) {
	            connection.disconnect(); // Disconnect...
			}
			connect(); // And connect again!
        }
        
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                          Chrome Extension Handlers                               //
        //////////////////////////////////////////////////////////////////////////////////////
        
        // Adds a listener on the connection status to be used in the bookmark
        chrome.extension.onConnect.addListener(function(port) {
            port.postMessage(currentConnectionStatus.msg);
            currentConnectionStatus.bind("change", function(msg) {
                port.postMessage(msg);
            });
        });
        
        // Handler messages
        chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
            if(request.settings) { // Settings
                if(request.settings.get) { // get them
                    sendResponse({value: inbox.get("settings."+request.settings.get[0])});
                }
                else if(request.settings.set) { // Set them
                    attrs = {};
                    attrs["settings."+request.settings.set[0]] = request.settings.set[1];
                    inbox.set(attrs);
                    inbox.save();
					sendResponse({value: true});
                }
            }
            else if (request.tab) { // Open tab
                chrome.tabs.create(request.tab);
            }
            else if (request.add) { // Add a new message to the inbox.
                message = inbox.addMessage(request.add);
                notify(message);
                sendResponse({value: message});
            }
            else if(request.subscribe) { // Subscribes to more feeds
                connection.superfeedr.subscribe(request.subscribe, function(result) {
                    var atom_id = "tag:superfeedr.com," + (new Date()).format("yyyy-mm-dd") + "/internal/subscriptions/" + escape(request.subscribe);
                   var msg = {
                      atom_id: atom_id,
                      title: "New subscription",
                      summary: "Successfully subscribed to " + request.subscribe,
                      read:true,
                      starred:false,
                      content : null,
                      links: {},
                      source: null
                    };
                    message = inbox.addMessage(msg);
                    notify(message);
                    sendResponse({value: result});
                })
            }
            else if(request.unsubscribe) { // Unsubscribes from feeds
                connection.superfeedr.unsubscribe(request.unsubscribe, function(result) {
                    sendResponse({value: result});
                })
            }
            else if(request.connect) {
                reconnect();
                sendResponse({value: true});
            }
        });
        
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                                        Main                                      //
        //////////////////////////////////////////////////////////////////////////////////////
        if(inbox.get("settings.jid")) { // If the settings are entered.
            connect();
        }
        else {
            // We need the user to enter its settings
            chrome.tabs.create({url:chrome.extension.getURL('/views/html/options.html'), selected: true});
        }

    </script>
</body>