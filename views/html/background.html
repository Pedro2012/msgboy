<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Msgboy</title>
    <meta name="application-name" content="Msgboy"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    
    <!-- Lib includes -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
	<script src="../../lib/strophejs/2.2.0-crypto-sha1.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/websocket.js" type="text/javascript"></script> 
    <script src="../../lib/date.format.js" type="text/javascript"></script> 
    
    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/strophe.superfeedr.js" type="text/javascript"></script> 
	<script src="../../controllers/strophe.caps.js" type="text/javascript" ></script>
    <script src="../../controllers/strophe.roster.js" type="text/javascript"></script> 
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
    
</head>
<body>
    <script language='javascript'>
	// Google Analytics
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-22746593-1']);
	_gaq.push(['_trackPageview']);

	(function () {
	    var ga = document.createElement('script');
	    ga.type = 'text/javascript';
	    ga.async = true;
	    ga.src = 'https://ssl.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0];
	    s.parentNode.insertBefore(ga, s);
	})();

	//////////////////////////////////////////////////////////////////////////////////////
	//                                Objects                                           //
	//////////////////////////////////////////////////////////////////////////////////////
	var inbox = new Inbox();
	var logEnabled = true;
	var currentConnectionStatus = {};
	var websocketEndpoint = 'ws://websocket.msgboy.com:5288/ws-xmpp'
	var connection = new Strophe.Connection({
	    protocol: new Strophe.Websocket(websocketEndpoint)
	});
	connection.max_stanzas_per_second = 3; // We limit to 3 stanzas per second.
	var password = "";
	var jid = "";
	var autoReconnect = true;
	var connectionWatchers = [];
	var rosterWatchers = []
	var currentNotification = null;
	var roster = {};

	connection.rawInput = function (data) {
	    log('RECV: ' + data);
	};
	connection.rawOutput = function (data) {
	    log('SENT: ' + data);
	};

	Strophe.log = function (level, msg) {
	    log(level + " :: " + msg);
	}
	
	//////////////////////////////////////////////////////////////////////////////////////
    //                                  Functions                                       //
    //////////////////////////////////////////////////////////////////////////////////////
    // Creates the HTML5 notification


    function notify(id) {
        _gaq.push(['_trackEvent', 'notification-showed']);

        log("Showing notification for " + id)
        if (!currentNotification) {
            url = chrome.extension.getURL('/views/html/notification.html');
            webkitNotification = window.webkitNotifications.createHTMLNotification(url);
            webkitNotification.onclose = function () {
                currentNotification = null;
            };
            webkitNotification.show();
            currentNotification = webkitNotification;
        }
        chrome.extension.sendRequest({
            "notify": {
                "message": id
            }
        }, function (response) {
            // Let's notify the people who may care about this!
        });
        return currentNotification;
    }

    // Logs messages to the console


    function log(msg) {
        if (logEnabled) {
            console.log(msg);
        }
    }

    // Handles XMPP Connections


    function onConnect(status) {
        var msg = currentConnectionStatus['msg'];
        if (status == Strophe.Status.CONNECTING) {
            msg = 'Msgboy is connecting.';
        } else if (status == Strophe.Status.CONNFAIL) {
            msg = 'Msgboy failed to connect.';
            setTimeout(function () {
                if (autoReconnect) connect
            }, 5000);
        } else if (status == Strophe.Status.AUTHFAIL) {
            msg = 'Msgboy couldn\'t authenticate. Please check your credentials';
            autoReconnect = false
            // We need to open the settings tab
            chrome.tabs.create({
                url: chrome.extension.getURL('/views/html/options.html'),
                selected: true
            });
        } else if (status == Strophe.Status.DISCONNECTING) {
            msg = 'Msgboy is disconnecting.';
        } else if (status == Strophe.Status.DISCONNECTED) {
            msg = 'Msgboy is disconnected. ';
            setTimeout(function () {
                if (autoReconnect) connect
            }, 5000);
        } else if (status == Strophe.Status.CONNECTED) {
            autoReconnect = true; // Set autoReconnect to true only when we've been connected :)
            msg = 'Msgboy is connected.';
			connection.caps.sendPresenceWithCaps(); // Send presence! 
        }
        currentConnectionStatus['msg'] = msg;
        currentConnectionStatus.trigger("change", msg);
        log(msg);
    } // function onConnect
    // Connects the XMPP Client


    function connect() {
        autoReconnect = true;
        password = inbox.get("settings.password");
        jid = inbox.get("settings.jid") + "@msgboy.com/extension";

        connection.connect(jid, password, onConnect);
    }

    // Disconnects to reconnect.


    function reconnect() {
        autoReconnect = true; // Let's make sure we have the autoReconnect.
        if (connection.status == Strophe.Status.CONNECTING || connection.status == Strophe.Status.CONNECTED || connection.status == Strophe.Status.DISCONNECTING) {
            connection.disconnect(); // Disconnect...
        } else if (
        connection.status == null || connection.status == Strophe.Status.DISCONNECTED || connection.status == Strophe.Status.CONNFAIL || connection.status == Strophe.Status.AUTHFAIL) {
            connect(); // Looks like we never tried to actually connect!
        }
    }

	chrome.management.get("fhedmfoledcafkkdnfmikkciacgoapom", function (extension_infos) {

	    //////////////////////////////////////////////////////////////////////////////////////
	    //                   XMPP Capabilities		                                        //
	    //////////////////////////////////////////////////////////////////////////////////////
	    connection.caps.setNode("http://download.msgboy.com/msgboy.crx")
	    connection.caps.addDiscoCategory(extension_infos.name + " " + extension_infos.version, "client", "web", "en");

	    connection.caps.addDiscoFeature("http://jabber.org/protocol/caps");
	    connection.caps.addDiscoFeature("http://jabber.org/protocol/disco#info");
	    connection.caps.addDiscoFeature("http://jabber.org/protocol/disco#items");
		

	    //////////////////////////////////////////////////////////////////////////////////////
	    //                   Notification Handler                                           //
	    //////////////////////////////////////////////////////////////////////////////////////
	    $(document).bind('notification', function (ev, msg) {
	        log("message-received");
	        _gaq.push(['_trackEvent', 'message-received']);
	        message = inbox.addMessage(msg);
	        if (message) {
	            log("notifying");
	            notify(message.toJSON().id);
	        }
	    });

	    //////////////////////////////////////////////////////////////////////////////////////
	    //                   Roster Changed Handler                                  	    //
	    //////////////////////////////////////////////////////////////////////////////////////
	    $(document).bind('roster_changed', function (ev, contacts) {
	        log("roster_changed");
	        _gaq.push(['_trackEvent', 'roster-changed']);
	        roster.contacts = contacts
	        roster.trigger("change", contacts);
	    });

	    //////////////////////////////////////////////////////////////////////////////////////
	    //                   Connection Requested Handler                                  	//
	    //////////////////////////////////////////////////////////////////////////////////////
	    $(document).bind('connection_requested', function (ev, connection_jid) {
	        log("connection_requested");
	        _gaq.push(['_trackEvent', 'connection_requested']);
			date = new Date();
			var atom_id = "tag:msgboy.com," + (new Date()).format("yyyy-mm-dd") + "/internal/connections/" + escape(connection_jid);
			msg = {
                id: MD5.hexdigest(atom_id + Math.random() * 11),
                atom_id: atom_id,
                published: date.toISOString(),
                updated: date.toISOString(),
                title: connection_jid + " wants to connect",
                summary: "You will be able to share content with " + connection_jid + ", and " + connection_jid + " will be able to share content with you.",
                read: true,
                starred: false,
                content: null,
                links: {
					"alternate": {
						"text/html": [
							{
								rel: "alternate",
								type: "text/html",
								title: connection_jid + " wants to connect",
								href: chrome.extension.getURL('/views/html/inbox.html')
							}
						]
					}
				},
				actions: { 
					'acceptConnection': {
						'name': 'Accept',
						'params': {'jid' : connection_jid}
					}, 
					'declineConnection': {
						'name': 'Decline',
						'params': {'jid' : connection_jid}
					}
				},
                source: null
            }
            message = inbox.addMessage(msg);
            if (message) {
                notify(message.toJSON().id);
            }
			
	        // connection.roster.approve(connection_jid);
	    });

	    //////////////////////////////////////////////////////////////////////////////////////
	    //                   Connection Status                                              //
	    //////////////////////////////////////////////////////////////////////////////////////
	    currentConnectionStatus['msg'] = 'Msgboy is disconnected. ';
	    _.extend(currentConnectionStatus, Backbone.Events);
	    currentConnectionStatus.bind("change", function (msg) {
	        $.each(connectionWatchers, function (index, port) {
	            try {
	                port.postMessage(msg);
	            } catch (error) {
	                log("Could not post message to port : " + error)
	            }
	        })
	    });

	    //////////////////////////////////////////////////////////////////////////////////////
	    //                   Roster			                                                //
	    //////////////////////////////////////////////////////////////////////////////////////
	    _.extend(roster, Backbone.Events);
	    roster.bind("change", function (roster) {
	        $.each(rosterWatchers, function (index, port) {
	            try {
	                port.postMessage(roster);
	            } catch (error) {
	                log("Could not post message to port : " + error)
	            }
	        })
	    });

	    //////////////////////////////////////////////////////////////////////////////////////
	    //                          Chrome Extension Handlers                               //
	    //////////////////////////////////////////////////////////////////////////////////////
	    // Adds a listener on the connection status to be used in the bookmark
	    chrome.extension.onConnect.addListener(function (port) {
	        log("New port connected : " + port.tab.id);
	        if (port.name == "connection") {
	            port.onDisconnect.addListener(function () {
	                log("This port was disconnected : " + port.tab.id)
	                idx = connectionWatchers.indexOf(port);
	                if (idx != -1) {
	                    connectionWatchers.splice(idx, 1);
	                }
	            });
	            port.postMessage(currentConnectionStatus.msg);
	            connectionWatchers.push(port);
	        } else if (port.name == "roster") {
	            port.onDisconnect.addListener(function () {
	                log("This port was disconnected : " + port.tab.id)
	                idx = rosterWatchers.indexOf(port);
	                if (idx != -1) {
	                    rosterWatchers.splice(idx, 1);
	                }
	            });
	            port.postMessage(roster.contacts);
	            rosterWatchers.push(port);
	        }
	    });

	    // Handler for messages
	    chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
	        if (request.settings) { // Settings
	            if (request.settings.get) { // get them
	                log("Request : settings.get")
	                sendResponse({
	                    value: inbox.get("settings." + request.settings.get[0])
	                });
	            } else if (request.settings.set) { // Set them
	                log("Request : settings.set")
	                attrs = {};
	                attrs["settings." + request.settings.set[0]] = request.settings.set[1];
	                inbox.set(attrs);
	                inbox.save();
	                sendResponse({
	                    value: true
	                });
	            }
	        } else if (request.tab) { // Open tab
	            _gaq.push(['_trackEvent', 'tab-opened']);
	            log("Request : tab")
	            chrome.tabs.create(request.tab);
	            sendResponse({
	                value: true
	            });
	        } else if (request.subscribe) { // Subscribes to more feeds
	            log("Request : subscribe")
	            _gaq.push(['_trackEvent', 'subscription-requested']);
	            connection.superfeedr.subscribe(request.subscribe, function (result) {
	                _gaq.push(['_trackEvent', 'feed-subscribed']);
	                var atom_id = "tag:msgboy.com," + (new Date()).format("yyyy-mm-dd") + "/internal/subscriptions/" + escape(request.subscribe);
	                var msg = {
	                    id: MD5.hexdigest(atom_id + Math.random() * 11),
	                    atom_id: atom_id,
	                    title: "New subscription",
	                    summary: "Successfully subscribed to " + request.subscribe,
	                    read: true,
	                    starred: false,
	                    content: null,
	                    links: {},
	                    source: null
	                };
	                message = inbox.addMessage(msg);
	                if (message) {
	                    notify(message.toJSON().id);
	                    sendResponse({
	                        value: result
	                    });
	                }
	            })
	        } else if (request.unsubscribe) { // Unsubscribes from feeds
	            log("Request : unsubscribe")
	            _gaq.push(['_trackEvent', 'unsubscription-requested']);
	            connection.superfeedr.unsubscribe(request.unsubscribe, function (result) {
	                _gaq.push(['_trackEvent', 'feed-unsubscribed']);
	                sendResponse({
	                    value: result
	                });
	            })
	        } else if (request.connect) {
	            _gaq.push(['_trackEvent', 'connection-initiated']);
	            log("Request : connect")
	            reconnect();
	            sendResponse({
	                value: true
	            });
	        } else if (request.reset) {
	            _gaq.push(['_trackEvent', 'reset-requested']);
	            log("Request : reset")
	            // First, disconnect
	            autoReconnect = false; // Let's make sure we don't the autoReconnect.
	            connection.disconnect();
	            // Then delete pending notifications
	            if (currentNotification) {
	                currentNotification.cancel();
	            }
	            // Finally, clean the storage.
	            localStorage.clear();
	            inbox = new Inbox();
	            sendResponse({
	                value: true
	            });
	        } else if (request.close) {
	            _gaq.push(['_trackEvent', 'notification-closed']);
	            log("Request : close")
	            currentNotification = null;
	            sendResponse({
	                value: true
	            });
	        } else if (request.addConnection) {
	            _gaq.push(['_trackEvent', 'connection-requested']);
	            log("Request : addConnection");
	            connection.roster.subscribe(request.addConnection);
	            sendResponse({
	                value: true
	            });
	        } else if (request.removeConnection) {
	            _gaq.push(['_trackEvent', 'connection-removed']);
	            log("Request : removeConnection");
	            connection.roster.unsubscribe(request.removeConnection);
	            sendResponse({
	                value: true
	            });
	        } else if (request.acceptConnection) {
	            _gaq.push(['_trackEvent', 'connection-accepted']);
	            log("Request : acceptConnection");
	            connection.roster.approve(request.acceptConnection);
	            connection.roster.subscribe(request.acceptConnection);
	            sendResponse({
	                value: true
	            });
	        } else if (request.refuseConnection) {
	            _gaq.push(['_trackEvent', 'connection-refused']);
	            log("Request : refuseConnection");
	            connection.roster.decline(request.acceptConnection);
	            connection.roster.unsubscribe(request.refuseConnection);
	            sendResponse({
	                value: true
	            });
	        } else {
	            log("Could not handle message : " + request)
	        }
	    });


	    //////////////////////////////////////////////////////////////////////////////////////
	    //                                        Main                                      //
	    //////////////////////////////////////////////////////////////////////////////////////
	    if (inbox.get("settings.jid")) { // If the settings are entered.
	        _gaq.push(['_trackEvent', 'connection-initiated']);
	        connect();
	    } else {
	        // We need the user to enter its settings
	        chrome.tabs.create({
	            url: chrome.extension.getURL('/views/html/options.html'),
	            selected: true
	        });
	    }

	});
	
	</script>
</body>