<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Msgboy</title>
    <meta name="application-name" content="Msgboy"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    
    <!-- Lib includes -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/websocket.js" type="text/javascript"></script> 
    <script src="../../lib/date.format.js" type="text/javascript"></script> 
    
    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/strophe.superfeedr.js" type="text/javascript"></script> 
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
    
</head>
<body>
    
    <!-- Less go! -->
    <script language='javascript'>
        
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                                Objects                                           //
        //////////////////////////////////////////////////////////////////////////////////////
        var inbox                   = new Inbox();
        var logEnabled              = true; 
        var currentConnectionStatus = {};
        var websocketEndpoint       = 'ws://msgboy.com:5288/ws-xmpp'
		var connection				= new Strophe.Connection({protocol: new Strophe.Websocket(websocketEndpoint)});
		connection.max_stanzas_per_second = 3; // We limit to 3 stanzas per second.
        var password                = "";
        var jid                     = "";
		var autoReconnect			= true;
		var ports					= [];
		var currentNotification		= null;
		
		connection.rawInput = function(data) {
            log('RECV: ' + data);
        };
        connection.rawOutput = function(data) {
            log('SENT: ' + data);
        };

		Strophe.log = function(level, msg) {
			log(level + " :: " + msg);
		}

        connection.superfeedr.addNotificationHandler(function(msg) {
            message = inbox.addMessage(msg);
			if(message) {
	            notify(message.toJSON().id);
			}
        }); //connection.superfeedr.addNotificationHandler 
        
        currentConnectionStatus['msg'] = ""
        _.extend(currentConnectionStatus, Backbone.Events);
		currentConnectionStatus.bind("change", function(msg) {
			$.each(ports, function(index, port) {
				try {
			        port.postMessage(msg);
				}
				catch(error) {
					log("Could not post message to port : " + error)
				}
			})
		});
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                                  Functions                                       //
        //////////////////////////////////////////////////////////////////////////////////////
        
        // Creates the HTML5 notification
        function notify(id) {
			log("Showing notification for " + id)
			if(!currentNotification) {
	            url = chrome.extension.getURL('/views/html/notification.html');
	            webkitNotification = window.webkitNotifications.createHTMLNotification(url);
				webkitNotification.onclose = function() {
					currentNotification = null;
				};
	            webkitNotification.show();
				currentNotification = webkitNotification;
			}
			chrome.extension.sendRequest({"notify": {"message" : id}}, function(response) {
				// Let's notify the people who may care about this!
			});
			return currentNotification;
        }
        
        // Logs messages to the console
        function log(msg) {
            if(logEnabled) {
                console.log(msg);
            }
        }
        
        // Handles XMPP Connections
        function onConnect(status) {	
            var msg = currentConnectionStatus['msg'];
            if (status == Strophe.Status.CONNECTING) {
                msg = 'Msgboy is connecting.';
            } else if (status == Strophe.Status.CONNFAIL) {
                msg = 'Msgboy failed to connect.';
                if(autoReconnect) {
					setTimeout(connect,5000);
				}
			} else if(status == Strophe.Status.AUTHFAIL) {
				msg = 'Msgboy couldn\'t authenticate. Please check your credentials';
				autoReconnect = false
            } else if (status == Strophe.Status.DISCONNECTING) {
                msg = 'Msgboy is disconnecting.';
            } else if (status == Strophe.Status.DISCONNECTED) {
                msg = 'Msgboy is disconnected. ';
                if(autoReconnect) {
					setTimeout(connect,5000);
				}
            } else if (status == Strophe.Status.CONNECTED) {
				autoReconnect = true; // Set autoReconnect to true only when we've been connected :)
                msg = 'Msgboy is connected.';
				connection.send($pres());// Send presence! connection.send($pres({xmlns: Strophe.NS.CLIENT}).c("priority").t("10000"));// Send presence!
            }
            currentConnectionStatus['msg'] = msg;
            currentConnectionStatus.trigger("change", msg);
            log(msg);
        } // function onConnect
        
        
        // Connects the XMPP Client
        function connect() {
			autoReconnect	= true;
            password 		= inbox.get("settings.password");
            jid 			= inbox.get("settings.jid") + "@msgboy.com/extension";

            connection.connect(jid, password, onConnect);
        }
        
        // Disconnects to reconnect.
        function reconnect() {
			autoReconnect = true; // Let's make sure we have the autoReconnect.
			if(connection.status == Strophe.Status.CONNECTED) {
	            connection.disconnect(); // Disconnect...
			} else if (connection.status == null) {
				connect(); // Looks like we never tried to actually connect!
			}
        }
        
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                          Chrome Extension Handlers                               //
        //////////////////////////////////////////////////////////////////////////////////////
        
        // Adds a listener on the connection status to be used in the bookmark
        chrome.extension.onConnect.addListener(function(port) {
			log("New port connected : " + port.tab.id);
			port.onDisconnect.addListener(function() {
				log("This port was disconnected : " + port.tab.id)
				idx = ports.indexOf(port);
			    if(idx!=-1) {
			      ports.splice(idx, 1);
			    }
			});
			port.postMessage(currentConnectionStatus.msg);
			ports.push(port);
        });
        
        // Handler messages
        chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
            if(request.settings) { // Settings
                if(request.settings.get) { // get them
					log("Request : settings.get" )
                    sendResponse({value: inbox.get("settings."+request.settings.get[0])});
                }
                else if(request.settings.set) { // Set them
					log("Request : settings.set" )
                    attrs = {};
                    attrs["settings."+request.settings.set[0]] = request.settings.set[1];
                    inbox.set(attrs);
                    inbox.save();
					sendResponse({value: true});
                }
            }
            else if (request.tab) { // Open tab
				log("Request : tab" )
                chrome.tabs.create(request.tab);
				sendResponse({value: true});
            }
            else if (request.add) { // Add a new message to the inbox.
				log("Request : add" )
				request.add["id"] = MD5.hexdigest(request.add.atom_id + Math.random()*11),
                message = inbox.addMessage(request.add);
				if(message) {
	                notify(message.toJSON().id);
				}
				sendResponse({value: message});
            }
            else if(request.subscribe) { // Subscribes to more feeds
				log("Request : subscribe" )
                connection.superfeedr.subscribe(request.subscribe, function(result) {
                   	var atom_id = "tag:msgboy.com," + (new Date()).format("yyyy-mm-dd") + "/internal/subscriptions/" + escape(request.subscribe);
 					var msg = {
					  id: MD5.hexdigest(atom_id + Math.random()*11),
                      atom_id: atom_id,
                      title: "New subscription",
                      summary: "Successfully subscribed to " + request.subscribe,
                      read:true,
                      starred:false,
                      content : null,
                      links: {},
                      source: null
                    };
                    message = inbox.addMessage(msg);
					if(message) {
						notify(message.toJSON().id);
	                    sendResponse({value: result});
					}
				})
            }
            else if(request.unsubscribe) { // Unsubscribes from feeds
				log("Request : unsubscribe" )
                connection.superfeedr.unsubscribe(request.unsubscribe, function(result) {
                    sendResponse({value: result});
                })
            }
            else if(request.connect) {
				log("Request : connect" )
                reconnect();
                sendResponse({value: true});
            }
			else if(request.reset) {
				log("Request : reset" )
				localStorage.clear();
			}
			else if(request.close) {
				log("Request : close" )
				currentNotification = null;
				sendResponse({value: true});
			}
			else {
				log("Could not handle message : " + request)
			}
        });
        
        
        //////////////////////////////////////////////////////////////////////////////////////
        //                                        Main                                      //
        //////////////////////////////////////////////////////////////////////////////////////
        if(inbox.get("settings.jid")) { // If the settings are entered.
            connect();
        }
        else {
            // We need the user to enter its settings
            chrome.tabs.create({url:chrome.extension.getURL('/views/html/options.html'), selected: true});
        }

    </script>
</body>