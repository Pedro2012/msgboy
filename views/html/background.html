<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Msgboy</title>
    <meta name="application-name" content="Msgboy"/>
    
    <!-- Lib includes -->
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
	<script src="../../lib/strophejs/2.2.0-crypto-sha1.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/websocket.js" type="text/javascript"></script> 
    <script src="../../lib/date.format.js" type="text/javascript"></script> 
	<script src="../../lib/strophe.caps.js" type="text/javascript" ></script>
	<script src="../../lib/strophe.superfeedr.js" type="text/javascript" ></script>
    
    <!-- Model includes -->
    <script src="../../models/database.js" type="text/javascript"></script> 
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
    <script src="../../controllers/uploader.js" type="text/javascript"></script> 
    
    <!-- Plugins includes -->
    <script src="../../controllers/plugins.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/generic.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/history.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/bookmarks.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/digg.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/disqus.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/github-repos.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/github-users.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/google-reader.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/tumblr.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/blogger.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/posterous.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/statusnet.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/typepad.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/quora-people.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/quora-topics.js" type="text/javascript"></script> 
    <script src="../../controllers/requests.js" type="text/javascript"></script> 
    
</head>
<body>
    <div id="log"></div>
    <script language='javascript'>
    
    // Google Analytics
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-22746593-1']);
    _gaq.push(['_trackPageview']);

    (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
    })();


    var inbox = new Inbox({
        id: "1"
    });
    var logEnabled = true;
    var websocketEndpoint = 'ws://websocket.msgboy.com:5288/ws-xmpp'
    var connection = new Strophe.Connection({
        protocol: new Strophe.Websocket(websocketEndpoint)
    });
    connection.max_stanzas_per_second = 3; // We limit to 3 outgoing stanzas per second.
    var autoReconnect = false;
    var currentNotification = null;
    var connection_timeout = null;
    var reconnectDelay = 0;

    connection.rawInput = function (data) {
        // log('RECV: ' + data);
    };
    connection.rawOutput = function (data) {
        // log('SENT: ' + data);
    };

    Strophe.log = function (level, msg) {
        log(msg);
    }

    // Logs messages to the console
    function log(msg) {
        if (logEnabled) {
            console.log(msg);
        }
    }

    // Handles XMPP Connections
    function onConnect(status) {
        if (status == Strophe.Status.CONNECTING) {
            msg = 'Msgboy is connecting.';
        } else if (status == Strophe.Status.CONNFAIL) {
            msg = 'Msgboy failed to connect.';
            setTimeout(function () {
                if (autoReconnect) {
                    reconnectDelay += 1;
                    connect();
                }
            }, fibonacci(reconnectDelay) * 1000);
            if (connection_timeout) clearTimeout(connection_timeout);
        } else if (status == Strophe.Status.AUTHFAIL) {
            msg = 'Msgboy couldn\'t authenticate. Please check your credentials';
            autoReconnect = false // We need to open the settings tab
            chrome.tabs.create({
                url: chrome.extension.getURL('/views/html/options.html'),
                selected: true
            });
            if (connection_timeout) clearTimeout(connection_timeout);
        } else if (status == Strophe.Status.DISCONNECTING) {
            msg = 'Msgboy is disconnecting.'; // We may want to time this out.
        } else if (status == Strophe.Status.DISCONNECTED) {
            msg = 'Msgboy is disconnected. ';
            setTimeout(function () {
                if (autoReconnect) {
                    reconnectDelay += 1;
                    connect();
                }
            }, fibonacci(reconnectDelay) * 1000);
            if (connection_timeout) clearTimeout(connection_timeout);
        } else if (status == Strophe.Status.CONNECTED) {
            reconnectDelay = 0
            autoReconnect = true; // Set autoReconnect to true only when we've been connected :)
            msg = 'Msgboy is connected.';
            connection.caps.sendPresenceWithCaps(); // Send presence! 
            if (connection_timeout) clearTimeout(connection_timeout);
        }
        log(msg);
    } // function onConnect
    
    // Connects the XMPP Client
    // It also includes a timeout that tries to reconnect when we could not connect in less than 1 minute.
    function connect() {
        connection_timeout = setTimeout(function () {
            // We add a 60 secinds reconnect when trying to connect.
            // If connection failed. We just try again.
            connect();
        }, 60 * 1000)
        var password = inbox.attributes.password;
        var jid = inbox.attributes.jid + "@msgboy.com/extension";

        connection.connect(jid, password, onConnect);
    }

    // Disconnects to reconnect.
    function reconnect() {
        if (connection.status == Strophe.Status.CONNECTING || connection.status == Strophe.Status.CONNECTED || connection.status == Strophe.Status.DISCONNECTING) {
            connection.disconnect(); // Disconnect...
        } else if (
        connection.status == null || connection.status == Strophe.Status.DISCONNECTED || connection.status == Strophe.Status.CONNFAIL || connection.status == Strophe.Status.AUTHFAIL) {
            connect(); // Looks like we never tried to actually connect!
        }
    }

    // Uploads the content of the database. this will be used for analysis of the dataset o determine a better algorithm.
    function uploadData() {
        var archive = new Archive();
        archive.all({
            created_at: [new Date().getTime(), 0]
        }, function () {
            $("#log").text(JSON.stringify(archive.toJSON()));
            MsgboyHelper.uploader.upload(inbox.attributes.jid, archive.toJSON());
        });
    }

    function notify(id) {
        // Open a notification window if needed!
        if (!currentNotification) {
            url = chrome.extension.getURL('/views/html/notification.html');
            webkitNotification = window.webkitNotifications.createHTMLNotification(url);
            webkitNotification.onclose = function () {
                currentNotification = null;
            };
            webkitNotification.show();
            currentNotification = webkitNotification;
        }
        chrome.extension.sendRequest({
            signature: "notify",
            params: {
                "message": id
            }
        }, function (response) {
            // Let's notify the people who may care about this, includingthe notification popup, hopefully :)
        });
        return currentNotification;
    }

    function subscribe(subs, callback) {
        // First, let's check if we have a subscription for this.
        var subscription = new Subscription({url: subs.url});
        subscription.fetch_or_create(function() {
            // Looks like there is a subscription.
            if(subscription.needs_refresh()) {
                subscription.set_state("subscribing", function() {
                    log("subscribing to " + subs.url);
                    connection.superfeedr.subscribe(subs.url, function (result, feed) {
                        log("subscribed to " + subs.url);
                        subscription.set_state("subscribed", function() {
                            callback(true);
                        });
                    });
                });
            }
            else {
                console.log("Nothing to do for " + JSON.stringify(subscription.attributes))
                callback(false);
            }
        });
    }

    inbox.bind("messages:added", function (message) {
        if (message.is_relevant()) {
            log("Relevant message : " + message.attributes.id + " (" + message.attributes.relevance + ") ");
            notify(message.id);
        } else {
            log("Not relevant message : " + message.attributes.id + " (" + message.attributes.relevance + ") ");
        }
    })

    // when the inbox is ready
    inbox.bind("ready", function () {
        connect();
    });

    // When the inbox is new.
    inbox.bind("new", function () {
        Plugins.import(function(subs) {
            subscribe(subs, function() {
                // Cool. Not much to do.
            })
        })
    });

    $(document).bind('notification_received', function (ev, notification) {
        log("Notification received from " + notification.source.url);
        var msg = connection.superfeedr.convertAtomToJson(notification.payload);
        msg.source = notification.source;
        msg.feed = notification.source.url;
        if (notification.via) {
            msg.via = notification.via
        }
        var message = inbox.add_message(msg, {
            success: function () {
                // Cool, message saved!
                log("Saved message " + msg.id);
            }.bind(this),
            error: function (object, error) {
                // Message was not saved... probably a dupe
                log("Could not save message " + JSON.stringify(msg));
                log(object);
                log(error);
            }.bind(this),
        });
    });

    // Chrome specific. We want to turn any Chrome API callback into a DOM event. It will greatly improve portability.
    chrome.extension.onRequest.addListener(function (_request, _sender, _sendResponse) {
        $(document).trigger(_request.signature, {
            request: _request,
            sender: _sender,
            sendResponse: _sendResponse
        });
    });

    connection.caps.setNode("http://download.msgboy.com/msgboy.crx")
    connection.caps.addDiscoFeature("http://jabber.org/protocol/caps");

    chrome.management.get(chrome.i18n.getMessage("@@extension_id"), function (extension_infos) {
        connection.caps.addDiscoCategory(extension_infos.name + " " + extension_infos.version, "client", "web", "en");
        // Let's go :)
        inbox.fetch_and_prepare();
    });

    // Plugins management
    $.each(Plugins.all, function (index, plugin) {
        if (typeof (plugin.subscribeInBackground) != "undefined") {
            plugin.subscribeInBackground(function (feed) {
                log("Request : subscribe " + feed.href);
                connection.superfeedr.subscribe(feed.href, function (result, f) {
                    log("Request : subscribed " + feed.href);
                })
            });
        }
    });
    </script>
</body>