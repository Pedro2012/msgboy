<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Growme"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/style.css" />


    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/messages.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/setting.js" type="text/javascript"></script> 
    <script src="../../models/settings.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

</head>
<body>
    <a href="/templates/subscriptions.html">Subscriptions</a>

    <div id="header"></div>
    <div id="nav"></div>
    <div id="inbox">
        <input id="filters" type="radio" name="filters" value="fetch" checked="checked">All Messages</input>
        <input id="filters" type="radio" name="filters" value="unread">Unread Messages</input>
        <input id="filters" type="radio" name="filters" value="starred">Starred Messages</input>
        <div class="title">
            <h1>Inbox</h1>
        </div>
        <div id="content">
        </div>
        <input type="button" id="loader" value="Load next page" />
    </div>

    <!-- Templates -->
    <script type="text/template" id="message-template">
    <div class="message<%= read ? ' read' : ' unread' %> <%= starred ? ' starred' : '' %>">
    <h3><a href="<%= main_link(links) %>" target="_blank"><%= title %></a></h3>
    <p>From : <a href="<%= source.url %>"><%= source.title %></a> (<a class="unsubscribe" href="">Unsubscribe</a>)</p>
    <div class="actions">
    <a href="" class="destroy">Destroy</a>&nbsp;
    <a href="" class="star"><%= starred ? 'Unstar' : 'Star' %> </a>&nbsp;
    <a href="" class="unread"><%= read ? 'Mark as unread' : 'Mark as read' %> </a>
    </div>
    </div>
    </script>

    <script>
    var jid = "subscriber@superfeedr.com";
    var inbox = new Inbox({id: jid});

    function main_link(links) {
        if(links["alternate"]) {
            if(links["alternate"]["text/html"]) {
                return links["alternate"]["text/html"][0].href;
            }
            else {
                // Hum, let's see what other types we have!
                return "";
            }
        }
        else {
            return "";
        }
    }

    var MessageView = Backbone.View.extend({

        events: {
            "click h3 a"                       : "openViewer",
            "click a.unsubscribe"              : "unsubscribeFeed",
            "click a.destroy"                  : "destroyMessage",
            "click a.star"                     : "toggleStarMessage",
            "click a.unread"                   : "toggleReadMessage"
        },

        initialize: function() {
            _.bindAll(this, "render", "openViewer", "unsubscribeFeed", "destroyMessage", "toggleStarMessage", "toggleReadMessage");
            this.model.bind('change', this.render);
            this.model.view = this;
        },

        render: function() {
            $(this.el).html(_.template($('#message-template').html(), this.model.toJSON()));
            return this;
        },

        openViewer: function() {
            this.model.set({"read": true});
            this.model.save();
            var link = main_link(this.model.toJSON().links);
            if(link == "") {
                alert("Sorry, there is no valid link for this story.")
            }
            else {
                chrome.tabs.create({url: link, selected: false});
            }
            return false;
        },

        unsubscribeFeed: function() {
            alert("TODO!");
            return false;
        },

        destroyMessage: function() {
            resp = confirm("Are you sure you want to delete this message? There is no way back.")
            if(resp) {
                this.model.destroy();
                $(this.el).remove();
            }
            return false;
        },

        toggleStarMessage: function() {
            if(this.model.get("starred")) {
                this.model.set({"starred": false});
            } 
            else {
                this.model.set({"starred": true});
            }
            this.model.save();
            return false;
        },

        toggleReadMessage: function() {
            if(this.model.get("read")) {
                this.model.set({"read": false});
            } 
            else {
                this.model.set({"read": true});
            }
            this.model.save();
            return false;
        },

    });

    var MessagesView = Backbone.View.extend({
        tagName: "div",
        className: "page",

        initialize: function() {
            _.bindAll(this, "render");
            this.collection.view = this;
        },

        render: function() {
            $("#" + this.collection.page).remove();
            $(this.el).attr("id", this.collection.page);
            var el = $(this.el);
            this.collection.each(function(msg) {
                view = new MessageView({model: msg});
                el.append(view.render().el); 
            })
            return this;
        },
    });

    // Our overall InboxView is the top-level piece of UI.
    var InboxView = Backbone.View.extend({
        current_page_number: null,
        events: {
            "click #loader" : "loadMore",
            "change #filters" : "refresh",
        },
        
        initialize: function() {
            _.bindAll(this, 'scrolled', 'showSinglePage', 'render', 'refresh', 'loadMore');
            this.current_page_number = inbox.get("current_page_number");
            this.render();
            $(document).scroll(this.scrolled) // Looks like we can't do it thru 'events' call. Is that a bug in Backbone?
        },

        scrolled: function() {
            if($(window).scrollTop() > $(document).height() - $(window).height() - 300) {
                // We're close to the bottom. Let's load an additional page!
                this.loadMore();
            }
        },
        
        loadMore: function() {
            // loadMore
            if(this.current_page_number == 1) {
                // We can't really go further!
                $("#loader").attr('disabled', true);
                $("#loader").attr('value', "No more pages to load");
            }
            else {
                this.current_page_number--;
                current_page = this.showSinglePage(this.current_page_number);
                if(current_page.length < 5) {
                    loadMore
                }
                this.refresh();
            }
        },

        showSinglePage: function(page_number) {
            messages = new Messages(page_number);
            messages.fetch();
            if(messages) {
                view = new MessagesView({collection: messages});
                $("#content").append(view.render().el);
            }
            else {
                alert("Looks like there is no more page!")
            }
            return messages;
        },

        render: function() {
            this.loadMore();
        },
        
        refresh: function() {
            this.$(".message").hide();
            switch($("#filters:checked").val()) {
                case "fetch":
                this.$(".message").css("display", "block");
                break;
                case "unread":
                this.$(".unread").css("display", "block");
                break;
                case "starred":
                this.$(".starred").css("display", "block");
                break;
                default:
                this.$(".message").css("display", "block");
            }
        }
        

    });

    var inboxView = new InboxView({el: "#inbox"});

    </script>
</body>
</html>


