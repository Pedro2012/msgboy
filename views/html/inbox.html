<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Growme"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/style.css" />


    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-localstorage/backbone-localstorage.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/base64.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/md5.js" type="text/javascript"></script> 
    <script src="../../lib/strophejs/core.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 

</head>
<body>

    <div id="nav">
        <span class="inbox">Inbox</span>
        <span class="settings">Settings</span>
    </div>
    
    <script>
    $("#nav span.inbox").click(function() {
        window.location = chrome.extension.getURL('/views/html/inbox.html')
        return false;
    })
    $("#nav span.settings").click(function() {
        window.location = chrome.extension.getURL('/views/html/options.html')
        return false;
    })
    </script>

    <div id="archive">
        <input id="filters" type="radio" name="filters" value="fetch" checked="checked">All Messages</input>
        <input id="filters" type="radio" name="filters" value="unread">Unread Messages</input>
        <input id="filters" type="radio" name="filters" value="starred">Starred Messages</input>
        <div class="title">
            <h1>Inbox</h1>
        </div>
        <div id="content">
        </div>
        <input type="button" id="loader" value="Load more" />
    </div>

    <!-- Templates -->
    <script type="text/template" id="message-template">
    <div class="message<%= read ? ' read' : ' unread' %> <%= starred ? ' starred' : '' %>">
        <h3><%= title %></h3>
        <% if(source) { %>
        <p>From : <a href="<%= source.url %>"><%= source.title %></a> (<a class="unsubscribe" href="">Unsubscribe</a>)</p>
        <% } %>
        <p><%= truncate(strip(summary), 240)%> &nbsp;
        <% if(main_link(links) != "") {
            %>
            <a href="<%= main_link(links) %>" target="_blank">read more</a>
            <%
        } %>
        </p>
        <div class="actions">
            <a href="" class="destroy">Destroy</a>&nbsp;
            <a href="" class="star"><%= starred ? 'Unstar' : 'Star' %> </a>&nbsp;
            <a href="" class="unread"><%= read ? 'Mark as unread' : 'Mark as read' %> </a>
        </div>
    </div>
    </script>

    <script>
    var archive = new Archive();

    var MessageView = Backbone.View.extend({

        events: {
            "click p a"                        : "openViewer",
            "click a.unsubscribe"              : "unsubscribeFeed",
            "click a.destroy"                  : "destroyMessage",
            "click a.star"                     : "toggleStarMessage",
            "click a.unread"                   : "toggleReadMessage"
        },

        initialize: function() {
            _.bindAll(this, "render", "openViewer", "unsubscribeFeed", "destroyMessage", "toggleStarMessage", "toggleReadMessage");
            this.model.bind('change', this.render);
            this.model.view = this;
            this.model.fetch();
        },

        render: function() {
            $(this.el).html(_.template($('#message-template').html(), this.model.toJSON()));
            return this;
        },

        openViewer: function() {
            this.model.set({"read": true});
            this.model.save();
            var link = main_link(this.model.toJSON().links);
            if(link == "") {
                alert("Sorry, there is no valid link for this story.")
            }
            else {
                chrome.tabs.create({url: link, selected: false});
            }
            return false;
        },

        unsubscribeFeed: function() {
            chrome.extension.sendRequest({unsubscribe: this.model.toJSON().source.url}, function(response) {
                alert("Unsubscribed");
            });
            return false;
        },

        destroyMessage: function() {
            resp = confirm("Are you sure you want to delete this message? There is no way back.")
            if(resp) {
                this.model.destroy();
                $(this.el).remove();
            }
            return false;
        },

        toggleStarMessage: function() {
            if(this.model.get("starred")) {
                this.model.set({"starred": false});
            } 
            else {
                this.model.set({"starred": true});
            }
            this.model.save();
            return false;
        },

        toggleReadMessage: function() {
            if(this.model.get("read")) {
                this.model.set({"read": false});
            } 
            else {
                this.model.set({"read": true});
            }
            this.model.save();
            return false;
        },

    });

    // Our overall InboxView is the top-level piece of UI.
    var ArchiveView = Backbone.View.extend({
        events: {
            "click #loader" : "loadMore",
            "change #filters" : "filter",
        },
        
        initialize: function() {
            _.bindAll(this, 'scrolled', 'showSinglePage', 'render', 'filter', 'loadMore');
            $(document).scroll(this.scrolled) // Looks like we can't do it thru 'events' call. Is that a bug in Backbone?
            this.collection.fetch();
            this.currentIndex = 0;
            this.loadMore();
        },

        scrolled: function() {
            if($(window).scrollTop() > $(document).height() - $(window).height() - 300) {
                // We're close to the bottom. Let's load an additional page!
                this.loadMore();
            }
        },
        
        loadMore: function() {
            message = this.collection.at(this.currentIndex);
            if(message) {
                this.currentIndex++
                var view = new MessageView({model: message});
				try {
                	this.$("#content").append(view.render().el);
                	this.filter();
				}
				catch(err) {
					logger.error("Couldn't display entry : " + JSON.stringify(message.toJSON()));
				}

                // We should also pre-emptively load more pages if the document is shorter than the page.
                if(document.documentElement.clientHeight == $(document).height()) {
                    this.loadMore()
                }
            }
            else {
                $("#loader").attr('disabled', true);
                $("#loader").attr('value', "No more pages to load");
            }
        },

        render: function() {
            this.loadMore();
        },
        
        filter: function() {
            this.$(".message").hide();
            switch($("#filters:checked").val()) {
                case "fetch":
                this.$(".message").css("display", "block");
                break;
                case "unread":
                this.$(".unread").css("display", "block");
                break;
                case "starred":
                this.$(".starred").css("display", "block");
                break;
                default:
                this.$(".message").css("display", "block");
            }
        }
    });

    var archiveView = new ArchiveView({el: "#archive", collection: archive});

    </script>
</body>
</html>


