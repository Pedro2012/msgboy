<!DOCTYPE HTML>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <title>
            Stream
        </title>
        <meta name="application-name" content="Msgboy" />
        <link rel="stylesheet" href="../css/style.css" />
        <link rel="stylesheet" href="../css/readability.css" />
        <link rel="stylesheet" href="../css/readability-print.css" />
        <!-- Lib includes -->
        <script src="../../lib/jquery/jquery.js" type="text/javascript"></script>
        <script src="../../lib/date.extensions.js" type="text/javascript"></script>
        <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script>
        <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script>
        <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script>
        <script src="../../lib/readability/readability.js" type="text/javascript"></script>
        <!-- Model includes -->
        <script src="../../models/database.js" type="text/javascript"></script>
        <script src="../../models/message.js" type="text/javascript"></script>
        <script src="../../models/archive.js" type="text/javascript"></script>
        <script src="../../models/inbox.js" type="text/javascript"></script>
        <!-- Controller includes -->
        <script src="../../controllers/utils.js" type="text/javascript"></script>
    </head>
    
    <body>
        <div id="nav">
            <span class="inbox">
                Stream
            </span>
            <span class="settings">
                Options
            </span>
            <script>
                $("#nav span.inbox").click(function() {
                    window.location = chrome.extension.getURL('/views/html/inbox.html')
                    return false;
                })
                $("#nav span.connections").click(function() {
                    window.location = chrome.extension.getURL('/views/html/connections.html')
                    return false;
                })
                $("#nav span.settings").click(function() {
                    window.location = chrome.extension.getURL('/views/html/options.html')
                    return false;
                })
            </script>
        </div>
        
        <span id="loader_frame"><img src="../icons/ajax-loader.gif" id="loader" /></span>
        <div id="archive">
            <input type="button" id="mark_all_as_read" value="Mark all as Read" />
            <input type="button" id="delete_all" value="Delete all" />
            <div id="content">
                <!-- Messages will be added here when loaded -->
            </div>
        </div>
        
        <!-- Templates -->
        <script type="text/template" id="message-template">
            <div id="<%= id %>" class="message<%= read_at ? ' read' : ' unread' %> <%= starred_at ? ' starred' : '' %>"> 
                <div class="publisher_info">
                    <a href="<%= alternate || source.url %>" target="_blank"><img class="icon" src="http://g.etfv.co/<%= alternate || source.url %>?defaulticon=lightpng" alt="<%= source.title %>" /> </a> 
                    <span class="publisher_actions"><span class="all">All</a> <span class="unsubscribe">Unsubscribe</a></span>
                </div>
                <div class="actions">
                <% 
                if(typeof actions != "undefined" && actions ) {
                    for (var name in actions) {
                        action = actions[name];
                %>
                <a href="" class="<%= name %>"><%= actions[name].name %></a> &nbsp;
                <%
                    }
                } 
                %> <a href="" class="destroy"><img src="../icons/trash-light.png" /></a>&nbsp; <a href="" class="star"><img src="../icons/star-<%= starred_at? 'yellow' : 'light' %>.png" /></a>
                </div>
                <small><%= source.title %></small>
                <h3><%= truncate(strip(title), 80) %></h3>
                <div class="readable-content"> 
                    <!-- Where the content from readability will be injected -->
                </div>
            </div>
        </script>
        <script>
            // Google Analytics
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-22746593-1']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script');
                ga.type = 'text/javascript';
                ga.async = true;
                ga.src = 'https://ssl.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(ga, s);
            })();

            // Readability
            var readStyle = 'style-newspaper'; // style-newspaper, style-novel, style-ebook, style-terminal
            var readSize = 'size-small'; // size-small, size-medium, size-large, size-x-large
            var readMargin = 'margin-narrow'; // margin-narrow, margin-medium, margin-wide, margin-x-wide


            $("div.actions a img").live("mouseover", function() {
                 var src = $(this).attr("src").replace("light", "dark");;
                 $(this).attr("src", src);
            });
            $("div.actions a img").live("mouseout", function() {
                var src = $(this).attr("src").replace("dark", "light");
                $(this).attr("src", src);
            });
            
            //////////////////////////////////////////////////////////////////////////////////////
            //                                Views                                           //
            //////////////////////////////////////////////////////////////////////////////////////
            var MessageView = Backbone.View.extend({
                events: {
                    "click span.unsubscribe": "unsubscribeFeed",
                    "click span.all": "showByAlternate",
                    "click a.destroy": "destroyMessage",
                    "click a.star": "toggleStarMessage",
                    "click a.unread": "toggleReadMessage",
                    "click div.message": "openViewer"
                },

                initialize: function() {
                    _.bindAll(this, "render", "openViewer", "unsubscribeFeed", "destroyMessage", "toggleStarMessage", "toggleReadMessage", "showByAlternate");
                    this.model.bind('change', this.render);
                    this.model.view = this;
                    this.model.fetch();
                },
                
                showByAlternate: function() {
                    archiveView.showByAlternate(this.model.attributes.alternate);
                    return false;
                },

                render: function() {
                    try {
                        $(this.el).html(_.template($('#message-template').html(), this.model.toJSON()));
                    } catch (err) {
                        logger.error("Couldn't display entry (" + err + "), : " + JSON.stringify(this.model.toJSON()));
                    }
                    
                    // Also attach actions!
                    that = this;
                    for (var callback in this.model.toJSON().actions) {
                        var action = this.model.toJSON().actions[callback]
                        $(this.el).find('a.' + callback).click(function(event) {
                            this.mark_as_read()
                            this[$(event.target).attr("class")](action.params.jid);
                            return false;
                        }.bind(this));
                    }

                    // And put the readable content in place!
                    var content = null;
                    
                    if (!this.model.attributes.content || $.trim(this.model.attributes.content) == "") {
                        content = readability.grabArticleFromElement(readability.prepDocumentFromString(this.model.attributes.summary));
                    } else {
                        content = readability.grabArticleFromElement(readability.prepDocumentFromString(this.model.attributes.content));
                    }
                    content = $($(content).html());
                    
                    // Now makes sure that all srcs and hrefs are absolute!
                    $.each(content.find("img"), function(idx, img) {
                        try {
                            if(parseUri($(img).attr("src")).relative == $(img).attr("src")) {
                                abs             = parseUri(this.model.attributes.links.alternate["text/html"][0].href)
                                abs.path        = $(img).attr("src")
                                abs.file        = "";
                                abs.query       = "";
                                abs.queryKey    = {};
                                abs.relative    = $(img).attr("src");
                                $(img).attr("src", abs.toString());
                            }
                        }
                        catch(e) {
                            // Forget it.
                        }
                    }.bind(this))
                    
                    // Now makes sure all links are absolute.
                    $.each(content.find("a"), function(idx, a) {
                        try {
                            if(parseUri($(a).attr("href")).relative == $(a).attr("href")) {
                                abs             = parseUri(this.model.attributes.links.alternate["text/html"][0].href)
                                abs.path        = $(a).attr("href")
                                abs.file        = "";
                                abs.query       = "";
                                abs.queryKey    = {};
                                abs.relative    = $(a).attr("href");
                                $(a).attr("href", abs.toString());
                                $(a).attr("target", "_blank");
                            }
                        }
                        catch(e) {
                            // Forget it.
                        }
                    }.bind(this))
                    
                    
                    this.$('.readable-content').html(content);
                    return this;
                },

                openViewer: function() {
                    this.model.mark_as_read()
                    var link = main_link(this.model.toJSON().links);
                    if (link == "") {
                        alert("Sorry, there is no valid link for this story.")
                    } else {
                        chrome.extension.sendRequest({
                            "tab": {
                                url: link,
                                selected: false
                            }
                        }, function(response) {});
                    }
                    return false;
                },

                unsubscribeFeed: function() {
                    this.model.mark_as_read()
                    chrome.extension.sendRequest({
                        unsubscribe: this.model.toJSON().source.url
                    }, function(response) {});
                    return false;
                },

                destroyMessage: function() {
                    resp = confirm("Are you sure you want to delete this message? There is no way back.")
                    if (resp) {
                        this.model.destroy();
                        $(this.el).remove();
                        archiveView.completePage();
                    }
                    return false;
                },

                toggleStarMessage: function() {
                    this.model.toggle_starred();
                    return false;
                },

                toggleReadMessage: function() {
                    this.model.toggle_read();
                    return false;
                },

            });

            // Our overall InboxView is the top-level piece of UI.
            var ArchiveView = Backbone.View.extend({

                events: {
                    "click #delete_all": "delete_all",
                    "click #mark_all_as_read": "mark_all_as_read",
                    "change .filters": "render"
                },

                defaultButtons: [
                    {
                        class: "created_at",
                        value: [new Date().getTime(), new Date().getTime() - 60000],
                        text: "All Messages"
                    },
                    {
                        class: "unread_at",
                        value: [new Date().getTime(), new Date().getTime() - 60000],
                        text: "Unread Messages"
                    },
                    {
                        class: "starred_at",
                        value: [new Date().getTime(), new Date().getTime() - 60000],
                        text: "Starred Messages"
                    }
                ],
                

                show_loader: function() {
                    this.loading = true;
                    $("#loader").show();
                },
                
                hide_loader: function() {
                    this.loading = false;
                    $("#loader").hide();
                },

                initialize: function() {
                    _.bindAll(this, 'scrolled', 'showSinglePage', 'render', 'filter', 'loadMore');
                    $(document).scroll(this.scrolled) // Looks like we can't do it thru 'events' call. Is that a bug in Backbone?
                    this.hide_loader();
                    this.render();
                },

                scrolled: function() {
                    this.completePage();
                },

                mark_all_as_read: function() {
                    this.show_loader();
                    this.collection.mark_all_as_read({
                        callback: function() {
                            this.filter();
                            this.hide_loader();
                        }.bind(this)
                    });
                },

                delete_all: function() {
                    if (confirm("This may take a few seconds, and there is no way back. Are you sure?")) {
                        this.show_loader();
                        this.collection.delete_all({
                            callback: function() {
                                this.filter();
                                this.hide_loader();
                            }.bind(this)
                        });
                    }
                },

                loadMore: function() {
                    if (new Date().getTime() - this.lower > inbox.attributes.epoch) {
                        if (!this.loading && !this.no_more) {
                            var condition = {}
                            var key = $(".filters input:checked").attr("class");
                            var value = JSON.parse($(".filters input:checked").val());
                            condition[key] = value;
                            this.show_loader();
                            this.collection.fetch_more(condition, function() {
                                this.hide_loader();
                                
                                _.each(this.collection, function(message, index) {
                                    this.showMessageAtBottom(this.collection.at(index));
                                }.bind(this));
                                
                                if(_.isArray(value)) {
                                    this.no_more = false; //  There is probably more!
                                    this.lower = this.lower + this.step;
                                    value = [value[1], value[1] - this.lower]
                                    $(".filters input:checked").val(JSON.stringify(value)); // Update the radio button's value
                                    this.completePage();
                                }
                                else {
                                    // No need to load further. Let's just castrate the value
                                    this.no_more = true;
                                }
                                
                            }.bind(this));
                        }
                    } else {
                        // No more to load. We want back to epoch!
                    }
                },
                
                showByAlternate: function(alt) {
                    this.showRadioButtons(this.defaultButtons.concat([
                        {
                            class: "alternate",
                            value: alt,
                            text: "Messages from " + alt
                        }
                    ]), "alternate");
                    this.$(".message").hide();
                    this.step  = 1000 * 60 * 10, // 10 minutes.
                    this.lower = 0;
                    this.loadMore();
                    return false
                    // Now, we need to use only the stuff we need!
                },

                showMessageOnTop: function(message) {
                    var view = new MessageView({
                        model: message
                    });
                    $("#content").prepend(view.render().el);
                },

                showMessageAtBottom: function(message) {
                    var view = new MessageView({
                        model: message
                    });
                    $("#content").append(view.render().el);
                },

                completePage: function() {
                    if ($("#content").height() < $(window).height()) {
                        // We should also pre-emptively load more pages if the document is shorter than the page.
                        this.loadMore();
                    } else if ($(window).scrollTop() > $(document).height() - $(window).height() - 300) {
                        // We're close to the bottom. Let's load an additional page!
                        this.loadMore();
                    }
                    else {
                        // Nothing to load
                    }
                },

                render: function() {
                    this.$(".message").hide();
                    this.step  = 1000 * 60 * 10, // 10 minutes.
                    this.lower = 0;
                    this.showRadioButtons(this.defaultButtons, $(".filters input:checked").attr("class") || this.defaultButtons[0].class);
                    this.no_more = false;
                    this.loadMore();
                },
                
                showRadioButtons: function(buttons, selected) {
                    $('.filters').remove();
                    _.each(buttons, function(button, index) {
                        var label = $("<label>", {
                           text: button.text,
                           class: "filters"
                        });
                        var btn = $("<input>", {
                            type: "radio",
                            name: "filters",
                            class: button.class,
                            value: JSON.stringify(button.value)
                        });
                        label.prepend(btn);
                        if(selected == button.class) {
                            btn.attr('checked', 'checked');
                        }
                        $("#archive").prepend(label);
                    }.bind(this));
                }
            });

            //////////////////////////////////////////////////////////////////////////////////////
            //                          Chrome Extension Handlers                               //
            //////////////////////////////////////////////////////////////////////////////////////
            // Listens to new messages coming from the background
            chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
                if (request.notify) {
                    message = new Message({
                        'id': request.notify.message
                    })
                    message.fetch({
                        success: function() {
                            archiveView.showMessageOnTop(message);
                        }
                    });
                }
            });


            var archiveView = null;
            var archive = null;
            var inbox = new Inbox({
                id: "1"
            });
            inbox.fetch({
                success: function() {
                    archive = new Archive();
                    archiveView = new ArchiveView({
                        el: "#archive",
                        collection: archive
                    });
                }
            })
        </script>
    </body>

</html>