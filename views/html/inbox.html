<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Msgboy"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script> 
    <script src="../../lib/date.extensions.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/database.js" type="text/javascript"></script> 
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
</head>
<body>

    <div id="nav">
        <span class="inbox">Inbox</span>
        <span class="connections">Connections</span>
        <span class="settings">Settings</span>
    </div>
    
    <script>
    $("#nav span.inbox").click(function() {
        window.location = chrome.extension.getURL('/views/html/inbox.html')
        return false;
    })
    $("#nav span.connections").click(function() {
        window.location = chrome.extension.getURL('/views/html/connections.html')
        return false;
    })
    $("#nav span.settings").click(function() {
        window.location = chrome.extension.getURL('/views/html/options.html')
        return false;
    })
    </script>

    <div id="archive">
	    <img src="../icons/ajax-loader.gif" id="loader"/>
    
        <input id="filters" type="radio" name="filters" value="fetch" checked="checked">All Messages</input>
        <input id="filters" type="radio" name="filters" value="unread">Unread Messages</input>
        <input id="filters" type="radio" name="filters" value="starred">Starred Messages</input>

        <div class="title">
            <h1>Inbox</h1>
        </div>
        <input type="button" id="mark_all_as_read" value="Mark all as Read" />
        <input type="button" id="delete_all" value="Delete all" />

        <div id="content">
        </div>
    </div>

    <!-- Templates -->
    <script type="text/template" id="message-template">
    <div id="<%= id %>" class="message<%= read_at ? ' read' : ' unread' %> <%= starred_at ? ' starred' : '' %>">
        <h3><%= title %></h3>
		<span class="time"><%= new Date(created_at).toRelativeTime() %></span>
        <% if(typeof(source) != "undefined" && source) { %>
        <p>From : <a href="<%= source.url %>"><%= source.title %></a> (<a class="unsubscribe" href="">Unsubscribe</a>)</p>
        <% } %>
        <% if(typeof(via) != "undefined" && via) { %>
        <p>Via : <%= via %></a></p>
        <% } %>

        <p><%= summary%> &nbsp;
        <% if(main_link(links) != "") {
            %>
            <a href="<%= main_link(links) %>" target="_blank" class="more">read more</a> | <a href="" target="_blank" class="viz">viz</a>
            <%
        } %>
        </p>
        <div class="actions">
			<% if(typeof actions == "undefined" || actions == null) {
			} else {
				for (var name in actions) {
					action = actions[name];
					%>
						<a href="" class="<%= name %>"><%= actions[name].name %></a>&nbsp;
					<%
		        }
			} %>
			<a href="" class="destroy">Destroy</a>&nbsp;
            <a href="" class="star"><%= starred_at ? 'Unstar' : 'Star' %> </a>&nbsp;
            <a href="" class="unread"><%= read_at ? 'Mark as unread' : 'Mark as read' %> </a>
        </div>
    </div>
    </script>

    <script>

	// Google Analytics
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-22746593-1']);
	_gaq.push(['_trackPageview']);

	(function () {
	    var ga = document.createElement('script');
	    ga.type = 'text/javascript';
	    ga.async = true;
	    ga.src = 'https://ssl.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0];
	    s.parentNode.insertBefore(ga, s);
	})();

	//////////////////////////////////////////////////////////////////////////////////////
	//                                Views                                           //
	//////////////////////////////////////////////////////////////////////////////////////
	var MessageView = Backbone.View.extend({
	    events: {
	        "click p a.more"		: "openViewer",
	        "click p a.viz"		    : "openViz",
	        "click a.unsubscribe"	: "unsubscribeFeed",
	        "click a.destroy"		: "destroyMessage",
	        "click a.star"			: "toggleStarMessage",
	        "click a.unread"		: "toggleReadMessage"
	    },

	    initialize: function () {
	        _.bindAll(this, "render", "openViewer", "unsubscribeFeed", "destroyMessage", "toggleStarMessage", "toggleReadMessage", "acceptConnection", "declineConnection", "viz");
	        this.model.bind('change', this.render);
	        this.model.view = this;
	        this.model.fetch();
	    },

	    render: function () {
	        try {
	            $(this.el).html(_.template($('#message-template').html(), this.model.toJSON()));
	        } catch (err) {
	            logger.error("Couldn't display entry (" + err + "), deleting it : " + JSON.stringify(this.model.toJSON()));
	            message.destroy();
	        }
			// Also attach actions!
			that = this;
			for (var callback in this.model.toJSON().actions) {
				var action = this.model.toJSON().actions[callback]
				$(this.el).find('a.' + callback).click(function(event){
					this.mark_as_read()
					this[$(event.target).attr("class")](action.params.jid);
					return false;
				}.bind(this));
	        }
	        _gaq.push(['_trackEvent', 'message-shown']);
	        return this;
	    },
	
		acceptConnection: function(jid) {
			chrome.extension.sendRequest({"acceptConnection": jid}, function (response) {});
			return false;
		},
		
		declineConnection: function(jid) {
			chrome.extension.sendRequest({"declineConnection": jid}, function (response) {});
			return false;
		},

	    openViewer: function () {
	        this.model.mark_as_read()
	        var link = main_link(this.model.toJSON().links);
	        if (link == "") {
	            alert("Sorry, there is no valid link for this story.")
	        } else {
	            chrome.extension.sendRequest({
	                "tab": {
	                    url: link,
	                    selected: false
	                }
	            }, function (response) {});
	        }
	        return false;
	    },
	
		openViz:function() {
            chrome.extension.sendRequest({
                "tab": {
                    url: chrome.extension.getURL('/views/html/read.html'),
                    selected: true
                }
            }, function (response) {});
			return false
		},

	    unsubscribeFeed: function () {
	        this.model.mark_as_read()
	        chrome.extension.sendRequest({
	            unsubscribe: this.model.toJSON().source.url
	        }, function (response) {});
	        return false;
	    },

	    destroyMessage: function () {
	        _gaq.push(['_trackEvent', 'message-destroyed']);
	        resp = confirm("Are you sure you want to delete this message? There is no way back.")
	        if (resp) {
	            this.model.destroy();
	            $(this.el).remove();
	            archiveView.completePage();
	        }
	        return false;
	    },

	    toggleStarMessage: function () {
			this.model.toggle_starred();
	        return false;
	    },

	    toggleReadMessage: function () {
			this.model.toggle_read();
	        return false;
	    },

	});

	// Our overall InboxView is the top-level piece of UI.
	var ArchiveView = Backbone.View.extend({
		
	    events: {
	        "click #delete_all": "delete_all",
	        "click #mark_all_as_read": "mark_all_as_read",
	        "change #filters": "filter"
	    },

	    initialize: function () {
			this.step = 60000, // 1 minute.
			this.current_filter  = "created_at";
			this.loading = false;
			this.lower = 0; 
	        _.bindAll(this, 'scrolled', 'showSinglePage', 'render', 'filter', 'loadMore');
	        $(document).scroll(this.scrolled) // Looks like we can't do it thru 'events' call. Is that a bug in Backbone?
			this.loadMore();
	    },

	    scrolled: function () {
	        if ($(window).scrollTop() > $(document).height() - $(window).height() - 300) {
	            // We're close to the bottom. Let's load an additional page!
	            this.loadMore();
	        }
	    },

	    mark_all_as_read: function () {
	        _gaq.push(['_trackEvent', 'messages-marked-all-read']);
			$("#loader").show();
	        this.collection.mark_all_as_read({
				start: 1,
				step: this.step,
				callback: function() {
					this.filter();
					$("#loader").hide();
				}.bind(this),
				epoch: inbox.attributes.epoch
			});
	    },

	    delete_all: function () {
			if(confirm("This may take a few seconds, and there is no way back. Are you sure?")) {
				_gaq.push(['_trackEvent', 'messages-deleted-all']);
				$("#loader").show();
		        this.collection.delete_all({
					start: 1,
					step: this.step,
					callback: function() {
						this.filter();
						$("#loader").hide();
					}.bind(this),
					epoch: inbox.attributes.epoch
				});
			}
	    },

		loadMore: function () {
			if(new Date().getTime() - this.lower > inbox.attributes.epoch) {
				if(!this.loading) {
					this.loading = true
					_gaq.push(['_trackEvent', 'messages-loaded-more']);
					this.collection.fetch_more(this.current_filter, this.lower, this.step, function() {
						this.loading = false
						this.lower = this.lower + this.step;
						_.each(this.collection, function(message, index) {
							this.showMessageAtBottom(this.collection.at(index));
						}.bind(this))
						this.completePage();
						this.scrolled(); // Let's call scrolled, just in case we're at the bottom of the page.
					}.bind(this))
				}
			} else {
				// No more to load. We want back to epoch!
				$("#loader").hide();
			}
		},

	    showMessageOnTop: function (message) {
	        var view = new MessageView({
	            model: message
	        });
	        $("#content").prepend(view.render().el);
	    },

	    showMessageAtBottom: function (message) {
	        var view = new MessageView({
	            model: message
	        });
	        this.$("#content").append(view.render().el);
	    },

	    completePage: function () {
	        // We should also pre-emptively load more pages if the document is shorter than the page.
	        if ($("#content").height() < $(window).height()) {
	            $("#loader").show();
				this.loadMore();
	        } else {
	            $("#loader").hide();
	        }
	    },

	    render: function () {
	        this.loadMore();
	    },

	    filter: function () {
	        this.$(".message").hide();
	        switch ($("#filters:checked").val()) {
	        case "fetch":
				this.current_filter = "created_at";
	            break;
	        case "unread":
				this.current_filter = "unread_at";
	            break;
	        case "starred":
				this.current_filter = "starred_at";
	            break;
	        default:
				this.current_filter = "created_at";
	        }
			this.lower = 0; 
			this.loadMore();
	    }
	});

	//////////////////////////////////////////////////////////////////////////////////////
	//                          Chrome Extension Handlers                               //
	//////////////////////////////////////////////////////////////////////////////////////
	// Listens to new messages coming from the background
	chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
	    if (request.notify) {
	        message = new Message({
	            'id': request.notify.message
	        })
	        message.fetch();
	        archiveView.showMessageOnTop(message);
	    }
	});

	
	var archiveView = null;
	var archive = null;
	var inbox = new Inbox({id: "1"});
	inbox.fetch({
		success: function() {
			archive = new Archive();
			archiveView = new ArchiveView({
			    el: "#archive",
			    collection: archive
			});
		}
	})

	</script>
</body>
</html>


