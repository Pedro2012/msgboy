<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Signing up</title>
    <meta name="application-name" content="Msgboy"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script> 
    <script src="../../lib/date.extensions.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/database.js" type="text/javascript"></script> 
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
</head>
<body>
    <h1>Signup</h1>
    
    <span>Step 1 of 3</span>
    
    <form accept-charset="UTF-8" id="new_user">
        <div id="error_explanation"> 
            <ul> 
            </ul>  
        </div>

        <div class="field"> 
            <label for="user_username">Username</label><br /> 
            <input id="user_username" name="user[username]" size="30" type="text" /> 
        </div> 
        <div class="field"> 
            <label for="user_email">Email</label><br /> 
            <input id="user_email" name="user[email]" size="30" type="text" /> 
        </div> 
        <div class="field"> 
            <label for="user_password">Password</label><br /> 
            <input id="user_password" name="user[password]" size="30" type="password" value="" /> 
        </div> 
        <div class="field"> 
            <label for="user_password_confirmation">Confirm password</label><br /> 
            <input id="user_password_confirmation" name="user[password_confirmation]" size="30" type="password" /> 
        </div> 

        <div class="actions"> 
            <input id="user_submit" name="commit" type="submit" value="Sign up" /> &nbsp; <a href="login.html">I already have an account</a>
        </div> 
    </form>
    <p id="connectionStatus"></p>

    <script>
    var base = "http://msgboy.com"

    var NewUserFormView = Backbone.View.extend({
        events: {
            "submit": "create",
        },

        initialize: function() {
            _.bindAll(this, "render");
        },

        render: function() {
            $("#error_explanation ul li").remove();
            for(var i in this.model) {
                if(i== "errors") {
                    _.each(this.model[i], function(error, field) {
                        if(field == "base") {
                            $("#error_explanation ul").append("<li>" + error + "</li>")
                        } else {
                            if(error instanceof Array) {
                                _.each(error, function(e) {
                                    $("#error_explanation ul").append("<li>" + field + " " + e + "</li>")
                                });
                            }
                            else {
                                $("#error_explanation ul").append("<li>" + field + " " + error + "</li>")
                            }
                        }
                    })
                } else {
                    $("#user_"+i).val(this.model[i])
                }
            }
        },

        create: function() {
            var params = {}
            _.each($("#new_user input"), function(input) {
                params[$(input).attr("name")] = $(input).val();
            });

            $.post( base + "/users.json", params, function(data) {
                this.model = data.user;
                var success = true
                console.log(data)
                console.log(this.model)
                _.each(this.model.errors, function(error, field) {
                    success = false
                });
                if(success) {
                    // We need to save the username and password!
                    chrome.extension.sendRequest({
                        "settings": {
                            "set": ["jid", this.model.username]
                        }
                    }, function (response) {
                        chrome.extension.sendRequest({
                            "settings": {
                                "set": ["password", $("#user_password").val()]
                            }
                        }, function (response) {
                            // Now we need to tell the msgboy to connect and then redirect to options!
                            chrome.extension.sendRequest({
                                connect: true
                            }, function (response) {
                                // Now let's see what the connection status is!
                                chrome.extension.connect({
                                    name: "connection"
                                }).onMessage.addListener(function (msg) {
                                    if (msg == "Msgboy is connected.") {
                                        // Cool, we're connected...
                                        window.location = chrome.extension.getURL('/views/html/plugins.html') // We redirect the user to the plugins!
                                    } else {
                                        // We should show this to the user!
                                        $('#connectionStatus').text(msg);
                                    }
                                });
                            }.bind(this));
                        }.bind(this));
                    }.bind(this)); 
                }
                else {
                    this.render();
                }
            }.bind(this));
            return false
        }
    });

    var view = new NewUserFormView({
        el: "#new_user"
    });

    $(document).ready(function() {
        var url = base + "/users/new.json";
        $.getJSON(url, function(data) {
            view.model = data.user;
            view.render();
        });
    });
    </script>


</body>
</html>
