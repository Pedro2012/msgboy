<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Inbox</title>
    <meta name="application-name" content="Msgboy"/>
    <meta name="description" content="__MSG_app_description__"/>
    <link rel="shortcut icon" href="http://superfeedr.com/favicon.ico">
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/connections.css" />

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery-1.5.1.min.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 
    <script src="../../models/subscription.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
</head>
<body>

    <div id="nav">
        <span class="inbox">Inbox</span>
        <span class="connections">Connections</span>
        <span class="settings">Settings</span>
    </div>
    
	<div id="roster">
		<h2>Connections</h2>
		<form id="add">
			<input id="jid" value="Your friend's login"  />
			<input type="submit" value="Add">
		</form>
		
	</div>
	
	<!-- Templates -->
    <script type="text/template" id="contact-template">
    <div class="contact <%= status %>">
		<% if(name) {
		%>
			<span class="name"><%= name %></span>
		<%
		} else {
		%>
			<span class="jid"><%= jid %></span>
		<%
		} 
		%>
		<input type="button" class="remove" value="remove" />
    </div>
    </script>

    <script>
	// Google Analytics
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-22746593-1']);
	_gaq.push(['_trackPageview']);

	(function () {
	    var ga = document.createElement('script');
	    ga.type = 'text/javascript';
	    ga.async = true;
	    ga.src = 'https://ssl.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0];
	    s.parentNode.insertBefore(ga, s);
	})();
	
    $("#nav span.inbox").click(function() {
        window.location = chrome.extension.getURL('/views/html/inbox.html')
        return false;
    })
    $("#nav span.connections").click(function() {
        window.location = chrome.extension.getURL('/views/html/connections.html')
        return false;
    })
    $("#nav span.settings").click(function() {
        window.location = chrome.extension.getURL('/views/html/options.html')
        return false;
    })


	var ContactView = Backbone.View.extend({
		events: {
			"click .remove" : "remove"
		},
		
		initialize: function () {
	        _.bindAll(this, "render", "remove");
	    },

	    render: function () {
		    $(this.el).html(_.template($('#contact-template').html(), this.model));
			return this;
	    },
	
		remove: function() {
			chrome.extension.sendRequest({removeConnection:this.model.jid}, function(response) {
			});
		}
	});
	
	var RosterView = Backbone.View.extend({
		events: {
			"submit #add": "add",
			"click #jid": "clear_jid"
		},
		
		initialize: function () {
	        _.bindAll(this, "render", "add", "clear_jid");
			this.render();
	    },

	    render: function () {
			this.$(".contact").remove();
			for(jid in this.collection) {
				contact = this.collection[jid];
				contact.jid = jid
				contact.status = "offline";
				online = false;
				for (var k in contact.resources) {
					online = true;
					break;
				}
				if (online) {
					away = true;
					for (var k in contact.resources) {
						if (contact.resources[k].show === "online") {
							away = false;
						}
					}
					contact.status = away ? "away" : "online";
				}
				var view = new ContactView({model : contact})
				$(this.el).append(view.render().el)
			}	        
	    },
	
		add: function() {
			contact = $.trim($("#jid").val());
			contact = contact.match(/@/) ? contact : contact + "@msgboy.com"
			var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
			if(contact.match(re)) {
				// Good, we have a full jid
				chrome.extension.sendRequest({addConnection:contact}, function(response) {
					alert("Request sent to " + contact)
				});
			}
			else {
				alert("Sorry, this doesn't seem to be a valid user name.")
				$("#jid").val("");
			}
			return false;
		},
		
		clear_jid: function() {
			$("#jid").val("")
		}
	
	});
	

	$(document).ready(function(){
	    // Loads the roster from the background page.
		port = chrome.extension.connect({
			name: "roster"
		})
		
		port.onMessage.addListener(function (contacts) {
			rosterView = new RosterView({el: "#roster", collection: contacts})
		});
		
	});
	</script>
	

</body>