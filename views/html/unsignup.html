<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Signing up</title>
    <meta name="application-name" content="Msgboy"/>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/unsignup.css" />

    <!-- Lib includes -->
    <script src="../../lib/jquery/jquery.js" type="text/javascript"></script> 
    <script src="../../lib/date.extensions.js" type="text/javascript"></script> 
    <script src="../../lib/underscore/underscore-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone/backbone-min.js" type="text/javascript"></script> 
    <script src="../../lib/backbone-indexeddb/backbone-indexeddb.js" type="text/javascript"></script> 

    <!-- Model includes -->
    <script src="../../models/database.js" type="text/javascript"></script> 
    <script src="../../models/message.js" type="text/javascript"></script> 
    <script src="../../models/archive.js" type="text/javascript"></script> 
    <script src="../../models/inbox.js" type="text/javascript"></script> 

    <!-- Controller includes -->
    <script src="../../controllers/utils.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/history.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/bookmarks.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/digg.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/disqus.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/github-repos.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/github-users.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/google-reader.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/tumblr.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/blogger.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/posterous.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/statusnet.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/typepad.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/quora-people.js" type="text/javascript"></script> 
    <script src="../../controllers/plugins/quora-topics.js" type="text/javascript"></script> 
</head>
<body>
    <div id="info">
        <p>The msgboy is an application which helps you stay in touch with what you care about on the web. </p>
        <p>It's currently trying to see what it can learn from you on the services you use the most. </p>
        <p>Later, it will show you pop-up notifications that tell you about these things you care about. They may or may not be accurate, but if you vote them up or down, the msgboy can learn to show only the right things.</p>
        <p id="connectionStatus">...</p>
    </div>

    <script>
    var statusMessage = {
        current: "",
        messages: ["Creating your account"]
    }
    
    function update_status_message() {
        if(statusMessage.messages.length > 0) {
            statusMessage.current = statusMessage.messages.shift();
            $('#connectionStatus').html(statusMessage.current + "...");
        }
        setTimeout(function() {
            update_status_message();
        }, 1000);
    }
    update_status_message(); // Let's go :)
    
    // Counter to help detect when we're done.
    var counter = {
        processing: [],
    };
    _.extend(counter, Backbone.Events);
    counter.bind("increment", function(name) {
        this.processing.push(name);
    });

    counter.bind("decrement", function(name) {
        this.processing = _.without(this.processing, name);
        if (this.processing.length == 0) {
            statusMessage.messages.push("<p>That's it! You're <a href=\"/views/html/dashboard.html\" class=\"done\">done, resume your browsing!</a></p>");
            $("#info").click("click", function() {
                window.open('', '_self', '');
                window.close();
                return false;
            })
        }
    });

    // This function makes sure we're connected.
    function connect(done) {
        chrome.extension.sendRequest({
            signature: "connect"
        }, function (response) {
            // Now let's see what the connection status is!
            chrome.extension.connect({
                name: "connection"
            }).onMessage.addListener(function (msg) {
                statusMessage.messages.push(msg)
                if (msg == "Msgboy is connected.") {
                    done();
                }
            });
        }.bind(this));
    }

    // This function subscribes the user to his personal firehose
    function prepare_firehose() {
        _.each(Plugins.all, function (plugin) {
            counter.trigger("increment", plugin.name);
            plugin.isUsing(function (using) {
                if(using) {
                    plugin.listSubscriptions(function(subscriptions) {
                        if(subscriptions.length > 0) {
                            statusMessage.messages.push("Importing " + plugin.name + "");
                        }
                        _.each(subscriptions, function(subscription) {
                            chrome.extension.sendRequest({
                                signature: "subscribe",
                                params: {
                                    url: subscription.url,
                                    title: subscription.title,
                                    notify: false
                                }
                            }, function(response) {
                            });
                        });
                        counter.trigger("decrement", plugin.name);
                    });
                }
                else {
                    counter.trigger("decrement", plugin.name);
                }
            });
        });
    }
    
    // This function regsiters a new user.
    function info_new_user(done) {
        var base = "http://msgboy.com";

        var params = {
            'user[username]': (new Date()).getTime().toString() + Math.floor((Math.random()*Math.pow(10,3))).toString(),
            'user[password]': Math.floor((Math.random()*Math.pow(10,16))).toString(),
        };
        params['user[password_confirmation]'] = params['user[password]'];

        $.post(base + "/users.json", params, function(data) {
            var success = true
            _.each(data.user.errors, function(error, field) {
                success = false
            });
            if(success) {
                chrome.extension.sendRequest({
                    signature: "settings",
                    params: {
                        "set": ["jid", data.user.username]
                    }
                }, function (response) {
                    chrome.extension.sendRequest({
                        signature: "settings",
                        params: {
                            "set": ["password", params["user[password]"]]
                        }
                    }, function (response) {
                        // Now we need to tell the msgboy to connect and then redirect to options!
                        done();
                    }.bind(this));
                }.bind(this)); 
            } else {
                console.log("We could not create user " + JSON.stringify(data.user))
            }
        });
        
    }
    
    // Let's go
    $(document).ready(function() {
        chrome.extension.sendRequest({
            signature: "settings",
            params: {
                "get": ["jid"]
            }
        }, function (response) {
            if(response.value && typeof(response.value) != "undefined") {
                prepare_firehose();
            } else {
                info_new_user(function() {
                    connect(function() {
                        prepare_firehose();
                    });
                });
            }
        });
    });
    </script>


</body>
</html>
